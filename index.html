<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG Sender - WhatsApp Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --accent: #667eea;
            --accent-dark: #764ba2;
            --bg-dark: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
        }

        /* Background Effects */
        body::before {
            content: '';
            position: fixed;
            top: -10%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: var(--primary);
            filter: blur(150px);
            opacity: 0.15;
            z-index: -1;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -10%;
            left: -10%;
            width: 400px;
            height: 400px;
            background: var(--accent);
            filter: blur(150px);
            opacity: 0.15;
            z-index: -1;
        }

        .container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            max-width: 900px;
            width: 100%;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .header {
            padding: 40px 30px;
            text-align: center;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.02);
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-muted);
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        @media (max-width: 600px) {
            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 26px;
            }

            .header p {
                font-size: 13px;
            }
        }

        .content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 600px) {
            .content {
                padding: 20px;
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .config-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
        }

        .config-section h2 {
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 13px;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px 14px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 14px;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 0 4px rgba(37, 211, 102, 0.1);
        }

        textarea {
            resize: none;
            min-height: 120px;
        }

        /* File Upload Styling */
        .file-upload-wrapper {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-upload-wrapper:hover {
            border-color: var(--primary);
            background: rgba(37, 211, 102, 0.05);
        }

        .file-upload-wrapper input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            pointer-events: none;
        }

        .file-upload-info span {
            font-size: 13px;
        }

        .icon-plus {
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* Info & Variable Pills */
        .variable-tips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .variable-pill {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: copy;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .variable-pill:hover {
            background: var(--primary);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Status & Logs */
        .preview-section {
            grid-column: span 2;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-top: 10px;
            border: 1px solid var(--glass-border);
        }

        @media (max-width: 768px) {
            .preview-section {
                grid-column: span 1;
            }
        }

        .preview-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .preview-item {
            padding: 10px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .preview-item:last-child {
            border-bottom: none;
        }

        /* Progress Bar */
        .progress-container {
            grid-column: span 2;
            display: none;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Buttons */
        .button-group {
            grid-column: span 2;
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .button-group {
                flex-direction: column;
                grid-column: span 1;
            }

            .button-group button {
                width: 100%;
            }
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: black;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2);
        }

        .btn-accent {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid var(--glass-border);
        }

        .btn-accent:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* AI Elements */
        .ai-badge {
            background: linear-gradient(45deg, #4285f4, #34a853, #fbbc05, #ea4335);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            font-size: 10px;
            letter-spacing: 1px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
        }

        .ai-card {
            background: rgba(66, 133, 244, 0.05);
            border: 1px dashed rgba(66, 133, 244, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Notifications */
        .status-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 12px;
            background: #1e293b;
            border: 1px solid var(--glass-border);
            display: none;
            animation: slideUp 0.3s ease;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Login Overlay */
        .login-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            /* Solid color to prevent overlap visuals */
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border-radius: 0 0 24px 24px;
            transition: all 0.5s ease;
            min-height: 400px;
        }

        .login-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-box {
            width: 100%;
            max-width: 300px;
            text-align: center;
        }

        /* Tabs System */
        .tabs-header {
            display: flex;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--glass-border);
            padding: 0 10px;
            overflow-x: auto;
            scroll-behavior: smooth;
        }

        .tabs-header::-webkit-scrollbar {
            height: 4px;
        }

        .tabs-header::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .tab-btn {
            padding: 15px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            transition: 0.3s;
            flex: none;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
            transform: none !important;
            box-shadow: none !important;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Maps Search styles */
        .maps-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .maps-item {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .maps-item:last-child {
            border-bottom: none;
        }

        .maps-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .maps-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Relat√≥rio de Disparos */
        .report-section {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
        }

        .report-list {
            max-height: 250px;
            overflow-y: auto;
            font-size: 12px;
        }

        .report-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid transparent;
        }

        .report-item.success {
            border-color: rgba(34, 197, 94, 0.2);
            background: rgba(34, 197, 94, 0.05);
        }

        .report-item.error {
            border-color: rgba(239, 68, 68, 0.2);
            background: rgba(239, 68, 68, 0.05);
        }

        .status-pill {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 10px;
            text-transform: uppercase;
        }

        .status-pill.success {
            background: #22c55e;
            color: #fff;
        }

        .status-pill.error {
            background: #ef4444;
            color: #fff;
        }

        /* QR Code Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            max-width: 400px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        .qr-placeholder {
            width: 250px;
            height: 250px;
            background: white;
            margin: 20px auto;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .qr-placeholder img {
            width: 100%;
            height: 100%;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <div id="qrModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeQRModal()">&times;</span>
            <h3 style="color: var(--primary); margin-bottom: 10px;">Conectar WhatsApp</h3>
            <p style="font-size: 13px; color: var(--text-muted);">Abra o WhatsApp > Configura√ß√µes > Aparelhos Conectados
                > Conectar um Aparelho</p>

            <div class="qr-placeholder" id="qrContainer">
                <div style="color: #000; font-size: 12px;">Gerando QR Code...</div>
            </div>

            <div id="connectionStatus" style="font-size: 14px; font-weight: 600; margin-top: 15px;">
                ‚è≥ Aguardando leitura...
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header" style="position: relative;">
            <h1 id="title-main">MG Sender <span style="font-weight: 300; opacity: 0.5;">v2.0</span></h1>
            <p>DESIGN PREMIUM &bull; DISPARO INTELIGENTE &bull; MULTI-M√çDIA</p>

            <!-- Bot√£o de Atalho para Configura√ß√µes -->
            <button onclick="switchTab('admin')" title="Configura√ß√µes (√Årea Admin)"
                style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #ffc107; font-size: 20px; transition: 0.3s;">
                ‚öôÔ∏è
            </button>
        </div>

        <div class="tabs-header">
            <button id="btn-tab-sender" class="tab-btn active" onclick="switchTab('sender')">üî• DISPARO EM
                MASSA</button>
            <button id="btn-tab-maps" class="tab-btn" onclick="switchTab('maps')">üìç EXTRA√á√ÉO MAPS</button>
            <button id="btn-tab-groups" class="tab-btn" onclick="switchTab('groups')">üë• EXTRA√á√ÉO GRUPOS</button>
            <button id="btn-tab-insta" class="tab-btn" onclick="switchTab('insta')">üì∏ EXTRA√á√ÉO INSTAGRAM</button>
            <button id="btn-tab-admin" class="tab-btn" onclick="switchTab('admin')" style="color: #ffc107;">‚öôÔ∏è
                ADMIN</button>
        </div>

        <!-- Tab 1: MG Sender -->
        <div id="tab-sender" class="tab-pane active">
            <div class="content">
                <div class="column">
                    <div class="config-section" style="margin-bottom: 20px;">
                        <h2>üì± Conex√£o WhatsApp</h2>
                        <div id="connectionPanel"
                            style="background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center;">
                            <div id="statusBadge"
                                style="display: inline-block; padding: 6px 15px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-bottom: 20px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2);">
                                üî¥ N√ÉO CONECTADO
                            </div>
                            <div id="instanceDisplayShort"
                                style="margin-bottom: 20px; font-size: 13px; color: var(--text-muted);">
                                Inst√¢ncia Ativa: <span style="color: var(--primary); font-weight: bold;"
                                    id="activeInstanceName">assessor_prosperazap</span>
                            </div>
                            <button id="btnConnect" class="btn-primary" onclick="startQRConnection()"
                                style="width: 100%; padding: 15px; font-weight: bold;">
                                üì≤ CONECTAR AGORA
                            </button>
                            <button id="btnLogout" class="btn-danger" onclick="forceLogout()"
                                style="width: 100%; padding: 10px; font-size: 11px; margin-top: 10px;">
                                üö™ DESCONECTAR WHATSAPP
                            </button>
                            <p
                                style="font-size: 11px; color: var(--text-muted); margin-top: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                                üí° Para alterar o Webhook ou Chaves de API, acesse a aba <strong>‚öôÔ∏è ADMIN</strong>.
                            </p>
                        </div>
                    </div>

                    <div class="config-section">
                        <h2>üìã Lista de Clientes</h2>
                        <div class="file-upload-wrapper">
                            <input type="file" id="excelFile" accept=".xlsx,.xls">
                            <div class="file-upload-info">
                                <div class="icon-plus">üìÅ</div>
                                <span id="fileNameDisplay">Arraste seu Excel ou clique aqui</span>
                            </div>
                        </div>
                        <div class="preview-section" id="previewSection" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px; color: var(--primary);">Total: <strong
                                        id="totalContacts">0</strong></span>
                                <label><input type="checkbox" id="selectAll" onchange="toggleSelectAll()" checked> <span
                                        style="font-size: 12px;">Todos</span></label>
                            </div>
                            <div class="preview-list" id="previewList"></div>
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="config-section">
                        <h2>üí¨ Mensagem Personalizada</h2>
                        <div class="form-group">
                            <textarea id="message"
                                placeholder="Ol√° {nome}, seu vencimento no dia {vencimento} est√° pr√≥ximo..."></textarea>
                            <div class="variable-tips" id="variableTips">
                                <span class="variable-pill" onclick="insertVar('{nome}')">{nome}</span>
                            </div>
                            <span style="font-size: 11px; color: var(--text-muted); float: right;"><span
                                    id="charCount">0</span> caracteres</span>
                        </div>

                        <div style="margin-top: 20px;">
                            <label>Anexar M√≠dia (Imagem/PDF/V√≠deo)</label>
                            <div class="file-upload-wrapper" style="padding: 10px;">
                                <input type="file" id="mediaFile" accept="image/*,application/pdf,video/*,audio/*">
                                <span id="mediaNameDisplay" style="font-size: 12px;">Clique para anexar arquivo</span>
                            </div>
                            <label style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="isAudio" style="width: auto;">
                                <span style="font-size: 12px;">Enviar como √Åudio Gravado</span>
                            </label>
                        </div>

                        <!-- SE√á√ÉO IA GENERATIVA -->
                        <div class="ai-card" id="aiSection">
                            <label
                                style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                                <span style="color: #4285f4; font-weight: bold; font-size: 13px;">‚ú® MODO IA GENERATIVA
                                    (AGENT)</span>
                                <input type="checkbox" id="useAI" style="width: auto;">
                            </label>
                            <div id="aiOptions" style="display: none; margin-top: 10px;">
                                <textarea id="aiPrompt"
                                    placeholder="Instru√ß√µes para a IA reescrever a mensagem... Ex: Reescreva de forma amig√°vel e use o nome do cliente."
                                    style="min-height: 80px; font-size: 12px; background: rgba(255,255,255,0.02);"></textarea>
                                <p style="font-size: 10px; color: var(--text-muted); margin-top: 5px;">A IA criar√° uma
                                    varia√ß√£o √∫nica para cada contato para evitar banimento.</p>
                            </div>
                        </div>
                    </div>

                    <div class="config-section" style="margin-top: 20px;">
                        <h2>üõ°Ô∏è Controle de Envio</h2>
                        <div class="form-group">
                            <label>Delay Vari√°vel (segundos) - Recomendado: 20 a 60s</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="number" id="minDelay" value="20" min="5">
                                <input type="number" id="maxDelay" value="60" min="10">
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label>üìÖ Agendamento (Opcional)</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="date" id="scheduleDate">
                                <input type="time" id="scheduleTime">
                            </div>
                            <p style="font-size: 10px; color: var(--text-muted); margin-top: 5px;">Se preenchido, o n8n
                                agendar√° o disparo.</p>
                        </div>
                    </div>
                </div>

                <div class="progress-container" id="progressContainer">
                    <div style="display: flex; justify-content: space-between; font-size: 11px;">
                        <span id="progressStatus">Enviando...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <!-- Painel de Relat√≥rio -->
                <div id="reportSection" class="report-section">
                    <div class="report-header">
                        <h3 style="font-size: 14px; color: var(--primary); margin: 0;">üìä Relat√≥rio de Disparo</h3>
                        <div id="reportStats" style="font-size: 11px; color: var(--text-muted);">
                            ‚úÖ <span id="reportSuccess" style="color: #22c55e; font-weight: bold;">0</span> |
                            ‚ùå <span id="reportError" style="color: #ef4444; font-weight: bold;">0</span>
                        </div>
                    </div>
                    <div id="reportList" class="report-list">
                        <!-- Itens do relat√≥rio aqui -->
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-danger" style="flex: 0.2;" onclick="limparFormulario()"
                        title="Recarregar tudo">RESET</button>
                    <button class="btn-warning" style="flex: 0.3; background: #f59e0b; color: #000;"
                        onclick="limparLista()">üóëÔ∏è ESVAZIAR LISTA</button>
                    <button class="btn-accent" style="flex: 0.2;"
                        onclick="document.getElementById('excelImportInput').click()">üì• IMPORTAR EXCEL</button>
                    <input type="file" id="excelImportInput" style="display: none;" accept=".xlsx, .xls, .csv"
                        onchange="importFromExcel(this)">
                    <button class="btn-accent" style="flex: 0.2;" onclick="agendarDisparo()">AGENDAR</button>
                    <button class="btn-primary" style="flex: 0.3;" id="btnSend" onclick="iniciarDisparo()">üî•
                        DISPARAR</button>
                </div>
            </div>
        </div>

        <!-- Tab 2: Maps -->
        <div id="tab-maps" class="tab-pane">
            <div class="content" style="grid-template-columns: 1fr;">
                <div class="config-section">
                    <h2>üìç Leads Google Maps</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="mapsQuery" placeholder="Dentistas em S√£o Paulo" style="flex: 1;">
                        <button class="btn-primary" onclick="searchMaps()" id="btnMapsSearch" style="width: auto;">üîç
                            BUSCAR</button>
                    </div>
                    <div id="mapsResultsCount"
                        style="font-size: 13px; color: var(--primary); display: none; margin-bottom: 10px;">
                        Encontrados: <strong id="totalMapsLeads">0</strong> leads
                    </div>
                    <div class="maps-results" id="mapsResultsList"></div>
                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn-primary" onclick="importLeadsToSender()" id="btnImportLeads" disabled>üì•
                            IMPORTAR</button>
                        <button class="btn-accent" onclick="exportToExcel(mapsLeads, 'leads_google_maps')">üìä EXPORTAR
                            EXCEL</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Grupos -->
        <div id="tab-groups" class="tab-pane">
            <div class="content" style="grid-template-columns: 1fr;">
                <div class="config-section">
                    <h2>üë• Grupos WhatsApp</h2>
                    <button class="btn-primary" onclick="fetchGroups()" style="width: auto; margin-bottom: 20px;">üîÑ
                        CARREGAR MEUS GRUPOS</button>
                    <div id="groupLoading" style="display:none; text-align:center; padding:10px;">‚è≥ Extraindo
                        participantes...</div>
                    <div id="groupsList" class="maps-results"></div>
                    <div id="groupResultsCount"
                        style="font-size: 13px; color: var(--primary); display: none; margin: 15px 0 10px 0;">
                        Extra√≠dos: <strong id="totalGroupLeads">0</strong> membros
                    </div>
                    <div class="button-group" id="groupButtonGroup" style="margin-top: 10px; display: none;">
                        <button class="btn-primary" onclick="importGroupLeads()">üì• IMPORTAR PARA DISPARO</button>
                        <button class="btn-accent" onclick="exportToExcel(groupLeads, 'membros_grupo_whatsapp')">üìä
                            EXPORTAR EXCEL</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: Instagram -->
        <div id="tab-insta" class="tab-pane">
            <div class="content" style="grid-template-columns: 1fr;">
                <div class="config-section">
                    <h2>üì∏ Leads Instagram</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="instaQuery" placeholder="@perfil ou #hashtag" style="flex: 1;">
                        <button class="btn-primary" onclick="searchInstagram()" id="btnInstaSearch"
                            style="width: auto;">üîç BUSCAR</button>
                    </div>
                    <div id="instaResults" class="maps-results"></div>
                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn-primary" onclick="importInstaLeads()" id="btnImportInsta">üì•
                            IMPORTAR</button>
                        <button class="btn-accent" onclick="exportToExcel(instaLeads, 'leads_instagram')">üìä
                            EXCEL</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 5: Admin -->
        <div id="tab-admin" class="tab-pane">
            <div class="content" style="grid-template-columns: 1fr; position: relative; padding: 0;">

                <div id="adminLoginOverlay" class="login-overlay">
                    <div class="login-box">
                        <h3 style="color: #ffc107; margin-bottom: 10px;">üîê √Årea do Administrador</h3>
                        <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 20px;">Acesso restrito.</p>
                        <input type="password" id="passAdmin" placeholder="Senha Master" style="margin-bottom: 12px;">
                        <button class="btn-primary" onclick="checkAdminLogin()"
                            style="background: #ffc107; color: #000; width: 100%;">LIBERAR</button>
                    </div>
                </div>

                <div class="config-section" style="margin: 30px;">
                    <h2 style="color: #ffc107;">‚öôÔ∏è Configura√ß√µes Evolution API</h2>

                    <div class="form-group">
                        <label>Webhook Principal</label>
                        <input type="text" id="n8nWebhook"
                            value="https://n8n.naturalisterravida.com.br/webhook/disparo-whatsapp">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>API Key Evolution</label>
                            <input type="text" id="apiKey" value="f98fed17beccac0149db6cfe6bfb7fff">
                        </div>
                        <div class="form-group">
                            <label>Inst√¢ncia Ativa</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="text" id="instanceName" value="assessor_prosperazap"
                                    onchange="document.getElementById('activeInstanceName').textContent = this.value">
                                <button onclick="generateNewInstance()"
                                    style="padding: 0; width: 45px; min-width: 45px; height: 45px; font-size: 18px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 12px; color: white;">üîÑ</button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>URL Evolution API</label>
                        <input type="text" id="evolutionUrl" value="https://evolution.naturalisterravida.com.br"
                            placeholder="https://sua-api.com">
                        <p style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">URL base da sua Evolution
                            API (sem / no final).</p>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>Webhook Instagram</label>
                        <input type="text" id="instaWebhook" placeholder="URL do n8n">
                    </div>

                    <hr style="border: 0; border-top: 1px solid var(--glass-border); margin: 30px 0;">

                    <div class="form-group" style="margin-top: 15px;">
                        <label>Modelo de IA</label>
                        <select id="geminiModel"
                            style="width: 100%; padding: 12px 14px; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--glass-border); border-radius: 12px; font-size: 14px; color: white;">
                            <option value="gemini-flash-latest" selected>Gemini Flash (Vers√£o Est√°vel Recomendada)
                            </option>
                            <option value="gemini-2.0-flash">Gemini 2.0 Flash (Alta Performance)</option>
                            <option value="gemini-pro-latest">Gemini Pro (Vers√£o Inteligente)</option>
                        </select>
                        <p style="font-size: 10px; color: #ffeb3b; margin-top: 6px;">‚ö†Ô∏è Se usar o Pro, use delays acima
                            de 40 segundos.</p>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <button class="btn-accent" onclick="testGeminiKey()"
                            style="width: 100%; background: #4285f4; color: white;">üîç TESTAR CHAVE GEMINI</button>
                    </div>
                    <label>Google Gemini API Key (Para Agente de Variedade)</label>
                    <input type="password" id="geminiKey" placeholder="Cole sua chave do Google AI Studio aqui">
                    <p style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">Pegue sua chave gr√°tis
                        em: <a href="https://aistudio.google.com/app/apikey" target="_blank"
                            style="color: #4285f4;">Google AI Studio</a></p>
                </div>

                <hr style="border: 0; border-top: 1px solid var(--glass-border); margin: 30px 0;">

                <h2 style="color: #ffc107;">üõ°Ô∏è Configura√ß√µes UazAPI</h2>
                <div class="form-group">
                    <label>URL UazAPI</label>
                    <input type="text" id="extractionApiUrl" value="https://prosperazap.uazapi.com">
                </div>
                <div class="form-group">
                    <label>Token UazAPI</label>
                    <input type="text" id="extractionApiKey" value="440ecac3-306c-4bdd-b14f-3c8e956830cd">
                </div>
                <input type="hidden" id="extractionInstance" value="default">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="useAlternativeApi" style="width: auto;">
                    <span style="font-size: 12px;">Usar UazAPI por padr√£o</span>
                </label>

                <button class="btn-primary" onclick="saveConfig()"
                    style="margin-top: 30px; width: 100%; background: #25D366; color: #000; font-weight: bold;">üíæ
                    SALVAR CONFIGURA√á√ïES</button>
            </div>
        </div>
    </div>
    </div> <!-- container -->

    <div class="status-toast" id="statusToast"></div>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script>
        let contatosData = [];
        let base64Media = null;
        let mediaFileName = null;
        let mediaMimeType = null;
        let mapsLeads = [];
        let instaLeads = [];
        let groupLeads = [];
        let statusInterval = null;
        let EVOLUTION_URL = 'https://evolution.naturalisterravida.com.br';

        // Initialize
        window.addEventListener('load', () => {
            const savedWebhook = localStorage.getItem('mg_webhook');
            const savedKey = localStorage.getItem('mg_apikey');
            const savedInstance = localStorage.getItem('mg_instance');
            const savedInstaWebhook = localStorage.getItem('mg_insta_webhook');
            const savedUazUrl = localStorage.getItem('mg_uaz_url');
            const savedUazToken = localStorage.getItem('mg_uaz_token');
            const savedUseUaz = localStorage.getItem('mg_use_uaz') === 'true';
            const savedGeminiKey = localStorage.getItem('mg_gemini_key');
            const savedAiPrompt = localStorage.getItem('mg_ai_prompt');
            const savedUseAI = localStorage.getItem('mg_use_ai') === 'true';
            const savedEvUrl = localStorage.getItem('mg_ev_url');

            if (savedWebhook) document.getElementById('n8nWebhook').value = savedWebhook;
            if (savedKey) document.getElementById('apiKey').value = savedKey;
            if (savedInstaWebhook) document.getElementById('instaWebhook').value = savedInstaWebhook;
            if (savedUazUrl) document.getElementById('extractionApiUrl').value = savedUazUrl;
            if (savedUazToken) document.getElementById('extractionApiKey').value = savedUazToken;
            if (savedGeminiKey) document.getElementById('geminiKey').value = savedGeminiKey;
            if (localStorage.getItem('mg_gemini_model')) document.getElementById('geminiModel').value = localStorage.getItem('mg_gemini_model');
            if (savedEvUrl) {
                document.getElementById('evolutionUrl').value = savedEvUrl;
                EVOLUTION_URL = savedEvUrl;
            }
            if (savedAiPrompt) document.getElementById('aiPrompt').value = savedAiPrompt;
            if (savedUseAI) {
                document.getElementById('useAI').checked = true;
                document.getElementById('aiOptions').style.display = 'block';
            }
            if (document.getElementById('useAlternativeApi')) document.getElementById('useAlternativeApi').checked = savedUseUaz;

            if (savedInstance) {
                document.getElementById('instanceName').value = savedInstance;
                updateConnectionUI(savedInstance);
                checkInstanceStatus(savedInstance);
            }

            // FILE HANDLERS
            document.getElementById('excelFile').addEventListener('change', handleExcelUpload);
            document.getElementById('mediaFile').addEventListener('change', handleMediaUpload);
        });

        function handleExcelUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('fileNameDisplay').textContent = file.name;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, { type: 'binary' });
                const wsname = wb.SheetNames[0];
                const ws = wb.Sheets[wsname];
                const data = XLSX.utils.sheet_to_json(ws);

                if (data.length > 0) {
                    const keys = Object.keys(data[0]);
                    contatosData = data.map(row => {
                        let phone = "";
                        // Find any key that looks like phone
                        keys.forEach(k => {
                            if (k.toLowerCase().includes('tel') || k.toLowerCase().includes('cel') || k.toLowerCase().includes('zap') || k.toLowerCase().includes('fone')) {
                                phone = String(row[k]).replace(/\D/g, "");
                            }
                        });

                        // Find any key that looks like name
                        let name = row['Nome'] || row['nome'] || row['Name'] || "Cliente";

                        return {
                            ...row,
                            _telefone_limpo: phone,
                            _nome_exibicao: name
                        };
                    });

                    // Dynamic Variable Tips
                    const variableTips = document.getElementById('variableTips');
                    variableTips.innerHTML = keys.map(k => `<span class="variable-pill" onclick="insertVar('{${k}}')">{${k}}</span>`).join('');

                    mostrarPreview();
                    showToast(`${contatosData.length} contatos carregados!`);
                }
            };
            reader.readAsBinaryString(file);
        }

        function handleMediaUpload(e) {
            const file = e.target.files[0];
            if (!file) {
                base64Media = null;
                mediaFileName = null;
                mediaMimeType = null;
                document.getElementById('mediaNameDisplay').textContent = "Clique para anexar arquivo";
                return;
            }
            document.getElementById('mediaNameDisplay').textContent = file.name;
            mediaFileName = file.name;
            mediaMimeType = file.type;
            const reader = new FileReader();
            reader.onload = (evt) => {
                base64Media = evt.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const pane = document.getElementById(`tab-${tab}`);
            const btn = document.getElementById(`btn-tab-${tab}`);
            if (pane) pane.classList.add('active');
            if (btn) btn.classList.add('active');
        }

        function checkAdminLogin() {
            const pass = document.getElementById('passAdmin').value;
            if (pass === '212003') {
                document.getElementById('adminLoginOverlay').classList.add('hidden');
                showToast('Acesso Liberado!');
            } else {
                showToast('Senha incorreta.', 'error');
            }
        }

        function saveConfig() {
            localStorage.setItem('mg_webhook', document.getElementById('n8nWebhook').value.trim());
            localStorage.setItem('mg_apikey', document.getElementById('apiKey').value.trim());
            localStorage.setItem('mg_instance', document.getElementById('instanceName').value.trim());
            localStorage.setItem('mg_insta_webhook', document.getElementById('instaWebhook').value.trim());
            localStorage.setItem('mg_uaz_url', document.getElementById('extractionApiUrl').value.trim());
            localStorage.setItem('mg_uaz_token', document.getElementById('extractionApiKey').value.trim());
            localStorage.setItem('mg_use_uaz', document.getElementById('useAlternativeApi').checked);
            localStorage.setItem('mg_gemini_key', document.getElementById('geminiKey').value.trim());
            localStorage.setItem('mg_ai_prompt', document.getElementById('aiPrompt').value.trim());
            localStorage.setItem('mg_use_ai', document.getElementById('useAI').checked);
            localStorage.setItem('mg_gemini_model', document.getElementById('geminiModel').value.trim());
            localStorage.setItem('mg_ev_url', document.getElementById('evolutionUrl').value.trim());
            EVOLUTION_URL = document.getElementById('evolutionUrl').value.trim();
            showToast("Configura√ß√µes salvas e limpas!");
        }

        // Toggle IA Options
        document.getElementById('useAI').addEventListener('change', function () {
            document.getElementById('aiOptions').style.display = this.checked ? 'block' : 'none';
        });

        function generateNewInstance() {
            const newName = "mg_" + Math.random().toString(36).substring(2, 7);
            document.getElementById('instanceName').value = newName;
            document.getElementById('activeInstanceName').textContent = newName;
            showToast("Nova inst√¢ncia: " + newName);
        }

        function updateConnectionUI(instance) {
            document.getElementById('activeInstanceName').textContent = instance;
        }

        async function checkInstanceStatus(instance) {
            const apiKey = document.getElementById('apiKey').value || 'f98fed17beccac0149db6cfe6bfb7fff';
            try {
                const res = await fetch(`${EVOLUTION_URL}/instance/connectionState/${instance}`, {
                    headers: { 'apikey': apiKey }
                });
                const data = await res.json();
                const badge = document.getElementById('statusBadge');
                if (data.instance && data.instance.state === "open") {
                    badge.innerHTML = "üü¢ WHATSAPP CONECTADO";
                    badge.style.color = "var(--primary)";
                }
            } catch (e) { }
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('statusToast');
            toast.textContent = msg;
            toast.style.borderColor = type === 'success' ? 'var(--primary)' : '#ef4444';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 4000);
        }

        // WhatsApp Connection
        // WhatsApp Connection
        async function startQRConnection() {
            let instance = document.getElementById('instanceName').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const evolutionUrl = (document.getElementById('evolutionUrl')?.value || EVOLUTION_URL).trim();

            if (!apiKey) {
                showToast("Erro: Chave API no Painel Admin est√° vazia!", "error");
                switchTab('admin');
                return;
            }

            if (!instance) {
                instance = 'mg_' + Math.random().toString(36).substring(2, 9);
                document.getElementById('instanceName').value = instance;
            }

            document.getElementById('qrModal').style.display = 'flex';
            const qrContainer = document.getElementById('qrContainer');
            qrContainer.innerHTML = '<div style="color: #000; font-size: 14px;">Iniciando conex√£o...</div>';

            try {
                // 1. Tenta criar a inst√¢ncia (ignora se der erro pois pode j√° existir)
                console.log("Tentando criar/verificar inst√¢ncia:", instance);
                await fetch(`${evolutionUrl}/instance/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'apikey': apiKey },
                    body: JSON.stringify({
                        instanceName: instance,
                        qrcode: true,
                        integration: 'WHATSAPP-BAILEYS'
                    })
                });

                // 2. Tenta buscar o QR Code independente da resposta do 'create'
                qrContainer.innerHTML = '<div style="color: #000; font-size: 14px;">Buscando QR Code...</div>';
                const res = await fetch(`${evolutionUrl}/instance/connect/${instance}`, {
                    headers: { 'apikey': apiKey }
                });

                const data = await res.json();

                if (data.base64) {
                    qrContainer.innerHTML = `<img src="${data.base64}" style="width:100%; border-radius: 8px;">`;
                    startStatusPolling(instance, apiKey);
                } else if (data.instance?.state === "open" || data.status === "open") {
                    qrContainer.innerHTML = '<div style="color: #25D366; font-size: 60px;">‚úÖ</div><div style="color: #000; margin-top: 10px; font-weight: 600;">WHATSAPP CONECTADO!</div>';
                    setTimeout(closeQRModal, 2500);
                    checkInstanceStatus(instance);
                    showToast("J√° est√° conectado!");
                } else {
                    if (res.status === 403 || res.status === 401) {
                        qrContainer.innerHTML = '<div style="color: #ef4444; padding: 20px; font-size: 14px;"><b>Erro 403: Acesso Negado</b><br>Sua API Key est√° incorreta no Admin ou a inst√¢ncia foi bloqueada.</div>';
                        showToast("Erro de API Key", "error");
                    } else {
                        qrContainer.innerHTML = `<div style="color: #000; font-size: 12px; padding: 10px;">Erro: ${data.message || 'Servidor n√£o enviou o QR Code'}</div>`;
                    }
                }
            } catch (e) {
                console.error("Erro Conex√£o:", e);
                qrContainer.innerHTML = `<div style="color: #ef4444; font-size: 12px; padding: 10px;">Erro de Rede: Verifique a URL da API no Admin.</div>`;
                showToast("Falha de rede com a API", "error");
            }
        }

        function startStatusPolling(instance, apiKey) {
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(async () => {
                const res = await fetch(`${EVOLUTION_URL}/instance/connectionState/${instance}`, { headers: { 'apikey': apiKey } });
                const data = await res.json();
                if (data.instance.state === "open") {
                    clearInterval(statusInterval);
                    closeQRModal();
                    checkInstanceStatus(instance);
                    showToast("Conectado!");
                }
            }, 3000);
        }

        function closeQRModal() { document.getElementById('qrModal').style.display = 'none'; clearInterval(statusInterval); }

        // GOOGLE MAPS EXTRACTION
        let mapService;
        function initAutocomplete() {
            console.log("Maps API Carregada");
            const mapDiv = document.createElement('div');
            mapDiv.id = "hiddenMapDiv";
            mapDiv.style.display = "none";
            document.body.appendChild(mapDiv);
            mapService = new google.maps.places.PlacesService(mapDiv);
        }

        async function searchMaps() {
            const query = document.getElementById('mapsQuery').value;
            if (!query) return showToast("Digite o que buscar.", "error");

            if (!mapService) {
                showToast("Erro: Google Maps n√£o carregado.", "error");
                return;
            }

            const btn = document.getElementById('btnMapsSearch');
            btn.disabled = true;
            btn.textContent = "‚åõ BUSCANDO...";

            let allResults = [];
            mapsLeads = []; // Limpa leads anteriores

            function processResults(results, status, pagination) {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    allResults = allResults.concat(results);

                    if (pagination && pagination.hasNextPage) {
                        showToast(`P√°gina 1 conclu√≠da, buscando mais... (${allResults.length} locais)`);
                        // O Google exige um delay de ~2s antes de permitir a pr√≥xima p√°gina
                        setTimeout(() => pagination.nextPage(), 2000);
                    } else {
                        // Fim das p√°ginas, agora busca detalhes (telefones)
                        fetchDetailedLeads(allResults);
                    }
                } else {
                    if (allResults.length > 0) fetchDetailedLeads(allResults);
                    else {
                        showToast("Nenhum resultado encontrado.", "error");
                        btn.disabled = false;
                        btn.textContent = "üîç BUSCAR";
                    }
                }
            }

            async function fetchDetailedLeads(results) {
                showToast(`Buscando detalhes/telefones de ${results.length} locais...`);
                const detailedLeads = [];

                for (let i = 0; i < results.length; i++) {
                    const place = results[i];
                    await new Promise(resolve => {
                        mapService.getDetails({
                            placeId: place.place_id,
                            fields: ['name', 'formatted_phone_number', 'formatted_address']
                        }, (details, detailStatus) => {
                            if (detailStatus === google.maps.places.PlacesServiceStatus.OK && details) {
                                const tel = details.formatted_phone_number || "";
                                detailedLeads.push({
                                    'Nome': details.name,
                                    'Telefone': tel || "Telefone n√£o dispon√≠vel",
                                    'Endere√ßo': details.formatted_address || "Endere√ßo n√£o dispon√≠vel",
                                    '_telefone_limpo': tel.replace(/\D/g, ""),
                                    '_nome_exibicao': details.name
                                });
                            }
                            setTimeout(resolve, 250); // Delay suave para n√£o travar API
                        });
                    });

                    // Atualiza status a cada 5 detalhes
                    if (i % 5 === 0) {
                        document.getElementById('totalMapsLeads').textContent = detailedLeads.length;
                    }
                }

                mapsLeads = detailedLeads;
                const comFone = mapsLeads.filter(l => l._telefone_limpo.length > 5).length;

                showToast(`${comFone} leads com telefone carregados!`);
                renderMapsResults();
                document.getElementById('mapsResultsCount').style.display = 'block';
                document.getElementById('totalMapsLeads').textContent = mapsLeads.length;
                document.getElementById('btnImportLeads').disabled = mapsLeads.length === 0;

                btn.disabled = false;
                btn.textContent = "üîç BUSCAR";
            }

            // Inicia a primeira chamada
            mapService.textSearch({ query: query }, processResults);
        }

        function renderMapsResults() {
            const list = document.getElementById('mapsResultsList');
            list.innerHTML = mapsLeads.map(l => `
                <div class="maps-item">
                    <div class="maps-info">
                        <h4>${l.Nome}</h4>
                        <p>${l.Telefone} | ${l.Endere√ßo}</p>
                    </div>
                </div>
            `).join('');
        }

        function importLeadsToSender() {
            if (mapsLeads.length === 0) return;
            contatosData = [...contatosData, ...mapsLeads];
            mostrarPreview();
            switchTab('sender');
            showToast(`${mapsLeads.length} leads importados!`);
        }

        // INSTAGRAM EXTRACTION
        async function searchInstagram() {
            const webhook = localStorage.getItem('mg_insta_webhook');
            const query = document.getElementById('instaQuery').value;
            if (!webhook || !query) return showToast("Configure o webhook e digite o perfil.", "error");

            const btn = document.getElementById('btnInstaSearch');
            btn.disabled = true;
            btn.textContent = "‚åõ BUSCANDO...";

            try {
                const res = await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                });
                const data = await res.json();
                // Assume o n8n retorna uma lista de perfis/leads
                instaLeads = data.map(i => ({
                    'Nome': i.full_name || i.username,
                    'Telefone': i.whatsapp || i.phone,
                    'Username': i.username,
                    '_telefone_limpo': (i.whatsapp || i.phone || "").replace(/\D/g, ""),
                    '_nome_exibicao': i.full_name || i.username
                })).filter(l => l._telefone_limpo.length > 5);

                renderInstaResults();
            } catch (e) { showToast("Erro ao buscar no Instagram.", "error"); }
            finally {
                btn.disabled = false;
                btn.textContent = "üîç BUSCAR";
            }
        }

        function renderInstaResults() {
            const list = document.getElementById('instaResults');
            list.innerHTML = instaLeads.map(l => `
                <div class="maps-item">
                    <div class="maps-info"><h4>${l.Nome}</h4><p>${l.Telefone} (@${l.Username})</p></div>
                </div>
            `).join('');
        }

        function importInstaLeads() {
            if (instaLeads.length === 0) return;
            contatosData = [...contatosData, ...instaLeads];
            mostrarPreview();
            switchTab('sender');
        }

        // EXPORT EXCEL
        function exportToExcel(data, filename) {
            if (data.length === 0) return showToast("Sem dados para exportar.", "error");
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Leads");
            XLSX.writeFile(workbook, `${filename}_${new Date().getTime()}.xlsx`);
            showToast("Exporta√ß√£o conclu√≠da!");
        }

        async function fetchGroups() {
            const inst = document.getElementById('instanceName').value;
            const key = document.getElementById('apiKey').value;
            const list = document.getElementById('groupsList');
            list.innerHTML = 'Buscando grupos...';

            // Diferentes vers√µes da API podem usar nomes variados para listar grupos
            const endpoints = [
                `${EVOLUTION_URL}/group/fetchAllGroups/${inst}?getParticipants=false`,
                `${EVOLUTION_URL}/group/findAllGroups/${inst}?getParticipants=false`
            ];

            let data = null;
            for (const url of endpoints) {
                try {
                    const res = await fetch(url, { headers: { 'apikey': key } });
                    if (res.ok) {
                        data = await res.json();
                        break;
                    }
                } catch (e) { console.error("Falha ao listar grupos no endpoint:", url); }
            }

            try {
                if (!data) throw new Error("A API n√£o respondeu ou a inst√¢ncia est√° desconectada.");

                // Tratar resposta que pode vir dentro de data ou ser o pr√≥prio array
                let groups = Array.isArray(data) ? data : (data.data || []);

                if (groups.length === 0) {
                    list.innerHTML = "Nenhum grupo encontrado.";
                    return;
                }

                list.innerHTML = groups.map(g => `
                    <div class="maps-item">
                        <div class="maps-info">
                            <h4>${g.subject || g.name || "Sem Nome"}</h4>
                            <p>${g.id || g.jid}</p>
                        </div>
                        <button class="btn-accent" onclick="extractGroupParticipants('${g.id || g.jid}', '${(g.subject || g.name || "Grupo").replace(/'/g, "")}')">EXTRAIR</button>
                    </div>
                `).join('');
            } catch (e) {
                console.error("Erro Listagem Grupos:", e);
                list.innerHTML = `Erro ao buscar grupos: ${e.message}`;
            }
        }

        async function extractGroupParticipants(id, name) {
            const inst = document.getElementById('instanceName').value;
            const key = document.getElementById('apiKey').value;
            document.getElementById('groupLoading').style.display = 'block';

            const encodedId = encodeURIComponent(id);
            const endpoints = [
                `${EVOLUTION_URL}/group/findGroupInfos/${inst}?groupJid=${encodedId}`,
                `${EVOLUTION_URL}/group/getParticipants/${inst}?groupJid=${encodedId}`,
                `${EVOLUTION_URL}/group/find/${inst}?groupJid=${encodedId}`
            ];

            let part = [];

            for (const url of endpoints) {
                try {
                    const res = await fetch(url, { headers: { 'apikey': key } });
                    if (res.ok) {
                        const temp = await res.json();
                        let found = [];

                        // Busca profunda para garantir que pegamos TODOS os membros
                        if (temp.participants && Array.isArray(temp.participants)) found = temp.participants;
                        else if (temp.participants && temp.participants.participants) found = temp.participants.participants;
                        else if (temp.data && temp.data.participants) found = temp.data.participants;
                        else if (temp.data && Array.isArray(temp.data)) found = temp.data;
                        else if (Array.isArray(temp)) found = temp;

                        if (found && found.length > 0) {
                            part = found;
                            break;
                        }
                    }
                } catch (e) { }
            }

            try {
                if (!part || part.length === 0) throw new Error("Membros n√£o encontrados.");

                const novosContatos = part.map(p => {
                    const pbs = [p.number, p.phoneNumber, p.id ? p.id.split('@')[0] : null, p.jid ? p.jid.split('@')[0] : null, p.id, p.jid];
                    let finalNum = "";
                    for (let v of pbs) {
                        if (v && typeof v === 'string' && !v.includes("lid") && v.replace(/\D/g, "").length >= 10 && v.replace(/\D/g, "").length <= 13) {
                            finalNum = v.replace(/\D/g, "");
                            break;
                        }
                    }
                    if (!finalNum) {
                        for (let v of pbs) {
                            if (v && typeof v === 'string' && !v.includes("lid") && v.replace(/\D/g, "").length > 5) {
                                finalNum = v.replace(/\D/g, "");
                                break;
                            }
                        }
                    }
                    const pName = p.pushName || p.pushname || p.name || p.verifiedName || "Membro";
                    const isReal = finalNum.length >= 8 && !finalNum.startsWith("0");
                    return {
                        'Nome': pName,
                        'Telefone': finalNum,
                        '_telefone_limpo': finalNum,
                        '_nome_exibicao': pName,
                        '_is_valid': isReal
                    };
                }).filter(c => c._is_valid);

                groupLeads = novosContatos;
                document.getElementById('totalGroupLeads').textContent = groupLeads.length;
                document.getElementById('groupResultsCount').style.display = 'block';
                document.getElementById('groupButtonGroup').style.display = 'flex';
                showToast(`${novosContatos.length} membros extra√≠dos!`);
            } catch (e) {
                showToast("Erro na extra√ß√£o. Verifique a conex√£o.", "error");
            } finally {
                document.getElementById('groupLoading').style.display = 'none';
            }
        }

        function importGroupLeads() {
            if (groupLeads.length === 0) return;
            contatosData = [...contatosData, ...groupLeads];
            mostrarPreview();
            switchTab('sender');
            showToast(`${groupLeads.length} contatos importados!`);
            // Limpa ap√≥s importar para evitar duplicidade visual
            document.getElementById('groupResultsCount').style.display = 'none';
            document.getElementById('groupButtonGroup').style.display = 'none';
        }

        async function importFromExcel(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet);

                const imported = rows.map(r => {
                    const telKey = Object.keys(r).find(k => k.toLowerCase().includes('tel') || k.toLowerCase().includes('num') || k.toLowerCase().includes('fone'));
                    const nameKey = Object.keys(r).find(k => k.toLowerCase().includes('nome') || k.toLowerCase().includes('cliente') || k.toLowerCase().includes('name'));

                    const telRaw = String(r[telKey] || "").replace(/\D/g, "");
                    return {
                        'Nome': r[nameKey] || "Cliente",
                        'Telefone': telRaw,
                        '_telefone_limpo': telRaw,
                        '_nome_exibicao': r[nameKey] || "Cliente"
                    };
                }).filter(c => c._telefone_limpo.length >= 8);

                if (imported.length > 0) {
                    contatosData = [...contatosData, ...imported];
                    mostrarPreview();
                    showToast(`${imported.length} contatos importados do Excel!`);
                } else {
                    showToast("Nenhum contato v√°lido encontrado no arquivo.", "error");
                }
                input.value = ""; // Reseta input
            };
            reader.readAsArrayBuffer(file);
        }

        function mostrarPreview() {
            const preview = document.getElementById('previewSection');
            preview.style.display = 'block';
            document.getElementById('totalContacts').textContent = contatosData.length;
            document.getElementById('selectAll').checked = true; // Reseta para selecionado
            document.getElementById('previewList').innerHTML = contatosData.map((c, i) => `
                <div class="preview-item" style="display: flex; align-items: center; gap: 10px; padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <input type="checkbox" class="contact-checkbox" checked>
                    <span style="font-size: 12px;">${c._nome_exibicao} (${c._telefone_limpo})</span>
                </div>
            `).join('');
        }

        function toggleSelectAll() {
            const isChecked = document.getElementById('selectAll').checked;
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            checkboxes.forEach(cb => cb.checked = isChecked);
        }

        function insertVar(v) {
            const msgArea = document.getElementById('message');
            const start = msgArea.selectionStart;
            const end = msgArea.selectionEnd;
            const text = msgArea.value;
            msgArea.value = text.substring(0, start) + v + text.substring(end);
            msgArea.focus();
        }

        function limparFormulario() { if (confirm("Isso recarregar√° a p√°gina e resetar√° todas as configura√ß√µes. Continuar?")) location.reload(); }

        function limparLista() {
            if (contatosData.length === 0) return showToast("A lista j√° est√° vazia.", "error");
            if (confirm(`Deseja remover os ${contatosData.length} contatos da lista?`)) {
                contatosData = [];
                mostrarPreview();
                document.getElementById('fileNameDisplay').textContent = "Arraste sua planilha aqui ou clique para buscar";
                showToast("Lista de contatos esvaziada!");
            }
        }

        function agendarDisparo() {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            if (!date || !time) return showToast("Selecione data e hora para agendar.", "error");

            if (contatosData.length === 0) return showToast("Carregue uma lista de contatos primeiro.", "error");

            if (confirm(`Confirmar agendamento de ${contatosData.length} mensagens para ${date} √†s ${time}?`)) {
                // We reuse startDisparo but the payload will contain schedule info
                iniciarDisparo(true);
            }
        }

        async function iniciarDisparo(isScheduled = false) {
            const webhook = document.getElementById('n8nWebhook').value;
            const msg = document.getElementById('message').value;
            const useAI = document.getElementById('useAI').checked;
            const aiPrompt = document.getElementById('aiPrompt').value;
            const geminiKey = document.getElementById('geminiKey').value;
            const geminiModel = document.getElementById('geminiModel').value;
            const isAudio = document.getElementById('isAudio').checked;

            const schDate = document.getElementById('scheduleDate').value;
            const schTime = document.getElementById('scheduleTime').value;

            if (!webhook || !msg) return showToast("Preencha os campos.", "error");
            if (contatosData.length === 0) return showToast("Selecione contatos.", "error");

            showToast(isScheduled ? "Agendando disparos..." : (useAI ? "Iniciando com Agente IA..." : "Iniciando disparo..."));
            saveConfig();

            // Progress Bar Init
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const progressStatus = document.getElementById('progressStatus');
            progressContainer.style.display = 'block';

            // Relat√≥rio Init
            document.getElementById('reportSection').style.display = 'block';
            document.getElementById('reportList').innerHTML = '';
            let sentCount = 0;
            let failCount = 0;
            document.getElementById('reportSuccess').textContent = '0';
            document.getElementById('reportError').textContent = '0';

            const checkboxes = document.querySelectorAll('.contact-checkbox');
            const contatosSelecionados = [];
            checkboxes.forEach((cb, i) => {
                if (cb.checked) contatosSelecionados.push(contatosData[i]);
            });

            if (contatosSelecionados.length === 0) return showToast("Selecione pelo menos um contato.", "error");

            let sent = 0;
            const total = contatosSelecionados.length;

            // Logic for looping contatosSelecionados and calling webhook
            for (let c of contatosSelecionados) {
                // If it's a real mass send, we don't want to block the UI forever
                // For scheduler, we might just send the whole list to n8n once?
                // But the current architecture sends 1 by 1.

                const inst = document.getElementById('instanceName').value.trim();
                const key = document.getElementById('apiKey').value.trim();

                const payload = {
                    number: c._telefone_limpo,
                    message: msg.replace(/{(\w+)}/gi, (match, key) => {
                        const foundKey = Object.keys(c).find(k => k.toLowerCase() === key.toLowerCase());
                        return foundKey ? c[foundKey] : match;
                    }),
                    instance: inst,
                    instanceName: inst, // Alias
                    sessao: inst, // Alias Portugu√™s
                    instancia: inst, // Alias Portugu√™s 2
                    apiKey: key,
                    apikey: key, // Alias lowercase
                    evolution_key: key,
                    evolution_url: EVOLUTION_URL,
                    useAI: useAI,
                    aiPrompt: aiPrompt.trim(),
                    aiKey: geminiKey.trim(),
                    aiModel: geminiModel.trim() || 'gemini-2.0-flash',
                    contactName: c._nome_exibicao,
                    media: isAudio ? null : base64Media,
                    audio: isAudio ? base64Media : null,
                    mediaName: mediaFileName,
                    mimeType: mediaMimeType,
                    isAudio: isAudio,
                    isScheduled: isScheduled,
                    scheduledAt: isScheduled ? `${schDate} ${schTime}` : null
                };

                let isSuccess = false;
                let errorMsg = "";

                try {
                    const response = await fetch(webhook, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        isSuccess = true;
                    } else {
                        const errorText = await response.text();
                        errorMsg = `Erro ${response.status}`;
                        console.error("Erro no Webhook:", errorText);
                    }
                } catch (e) {
                    errorMsg = "Erro de Rede";
                    console.error("Erro no envio", e);
                }

                // Adicionar ao Relat√≥rio
                const reportList = document.getElementById('reportList');
                const reportItem = document.createElement('div');
                reportItem.className = `report-item ${isSuccess ? 'success' : 'error'}`;
                reportItem.innerHTML = `
                    <span>${c._nome_exibicao} (${c._telefone_limpo})</span>
                    <span class="status-pill ${isSuccess ? 'success' : 'error'}">${isSuccess ? 'ENVIADO' : errorMsg}</span>
                `;
                reportList.prepend(reportItem);

                if (isSuccess) {
                    sentCount++;
                    document.getElementById('reportSuccess').textContent = sentCount;
                } else {
                    failCount++;
                    document.getElementById('reportError').textContent = failCount;
                }

                sent++;
                const percent = Math.round((sent / total) * 100);
                progressFill.style.width = `${percent}%`;
                progressPercent.textContent = `${percent}%`;
                progressStatus.textContent = `Enviando ${sent}/${total}...`;

                // Anti-Ban Delay
                const min = parseInt(document.getElementById('minDelay').value) || 5;
                const max = parseInt(document.getElementById('maxDelay').value) || 15;
                const delay = Math.floor(Math.random() * (max - min + 1) + min) * 1000;

                if (sent < total) await new Promise(r => setTimeout(r, delay));
            }
            showToast(isScheduled ? "Agendamento conclu√≠do no n8n!" : "Disparo conclu√≠do!");
        }

        async function testGeminiKey() {
            const key = document.getElementById('geminiKey').value.trim();
            const model = document.getElementById('geminiModel').value.trim();
            if (!key) return showToast("Insira a chave Gemini primeiro.", "error");

            showToast("Diagnosticando conex√£o com Google AI...");

            async function tryCall(apiVersion, modelName) {
                try {
                    const url = `https://generativelanguage.googleapis.com/${apiVersion}/models/${modelName}:generateContent?key=${key}`;
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Oi" }] }] })
                    });
                    return { ok: res.ok, status: res.status, data: await res.json() };
                } catch (e) { return { ok: false, error: e.message }; }
            }

            // Tenta v1beta primeiro
            let result = await tryCall('v1beta', model);

            if (result.ok) {
                return showToast(`‚úÖ SUCESSO! Modelo ${model} ativo na v1beta.`, "success");
            }

            // Se falhou 404, tenta v1
            if (result.status === 404) {
                showToast("Tentando vers√£o est√°vel da API...");
                result = await tryCall('v1', model);
                if (result.ok) return showToast(`‚úÖ SUCESSO! Modelo ${model} ativo na v1.`, "success");
            }

            // Se tudo falhou, tenta Listar Modelos para ajudar o usu√°rio
            try {
                const listUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`;
                const listRes = await fetch(listUrl);
                const listData = await listRes.json();

                if (listData.models) {
                    const available = listData.models.map(m => m.name.split('/').pop()).filter(n => n.includes('gemini'));
                    console.log("Modelos dispon√≠veis para sua chave:", available);
                    showToast(`‚ùå O modelo ${model} n√£o deu certo. Modelos dispon√≠veis na sua chave: ${available.slice(0, 2).join(', ')}... Verifique o console (F12) para a lista completa.`, "error");
                } else {
                    showToast(`‚ùå Erro Cr√≠tico: ${result.data?.error?.message || "Chave inv√°lida ou bloqueada"}`, "error");
                }
            } catch (e) {
                showToast("Erro ao diagnosticar modelos.", "error");
            }
        }

        async function forceLogout() {
            const inst = document.getElementById('instanceName').value;
            const key = document.getElementById('apiKey').value;
            if (confirm("Desconectar WhatsApp?")) {
                await fetch(`${EVOLUTION_URL}/instance/logout/${inst}`, { method: 'DELETE', headers: { 'apikey': key } });
                location.reload();
            }
        }
    </script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWIu9AMbRBq9eAZ7B_OzjBoLjfPIfiXZg&libraries=places&callback=initAutocomplete"></script>
</body>

</html>