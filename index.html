<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG Sender - WhatsApp Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --accent: #667eea;
            --accent-dark: #764ba2;
            --bg-dark: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
        }

        /* Background Effects */
        body::before {
            content: '';
            position: fixed;
            top: -10%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: var(--primary);
            filter: blur(150px);
            opacity: 0.15;
            z-index: -1;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -10%;
            left: -10%;
            width: 400px;
            height: 400px;
            background: var(--accent);
            filter: blur(150px);
            opacity: 0.15;
            z-index: -1;
        }

        .container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            max-width: 900px;
            width: 100%;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .header {
            padding: 40px 30px;
            text-align: center;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.02);
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-muted);
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        @media (max-width: 600px) {
            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 26px;
            }

            .header p {
                font-size: 13px;
            }
        }

        .content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 600px) {
            .content {
                padding: 20px;
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .config-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
        }

        .config-section h2 {
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 13px;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea {
            width: 100%;
            padding: 12px 14px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 14px;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 0 4px rgba(37, 211, 102, 0.1);
        }

        textarea {
            resize: none;
            min-height: 120px;
        }

        /* File Upload Styling */
        .file-upload-wrapper {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-upload-wrapper:hover {
            border-color: var(--primary);
            background: rgba(37, 211, 102, 0.05);
        }

        .file-upload-wrapper input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            pointer-events: none;
        }

        .file-upload-info span {
            font-size: 13px;
        }

        .icon-plus {
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* Info & Variable Pills */
        .variable-tips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .variable-pill {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: copy;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .variable-pill:hover {
            background: var(--primary);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Status & Logs */
        .preview-section {
            grid-column: span 2;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-top: 10px;
            border: 1px solid var(--glass-border);
        }

        @media (max-width: 768px) {
            .preview-section {
                grid-column: span 1;
            }
        }

        .preview-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .preview-item {
            padding: 10px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .preview-item:last-child {
            border-bottom: none;
        }

        /* Progress Bar */
        .progress-container {
            grid-column: span 2;
            display: none;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Buttons */
        .button-group {
            grid-column: span 2;
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .button-group {
                flex-direction: column;
                grid-column: span 1;
            }

            .button-group button {
                width: 100%;
            }
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: black;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2);
        }

        .btn-accent {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid var(--glass-border);
        }

        .btn-accent:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Notifications */
        .status-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 12px;
            background: #1e293b;
            border: 1px solid var(--glass-border);
            display: none;
            animation: slideUp 0.3s ease;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .media-preview-item {
            font-size: 11px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-media {
            color: #ef4444;
            cursor: pointer;
        }

        /* Login Overlay */
        .login-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border-radius: 16px;
            transition: all 0.5s ease;
        }

        .login-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-box {
            width: 100%;
            max-width: 300px;
        }

        .login-box h3 {
            margin-bottom: 20px;
            text-align: center;
            color: var(--primary);
            font-size: 18px;
        }

        .login-box input {
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-login {
            width: 100%;
            background: var(--primary);
            color: #000;
            margin-top: 10px;
        }

        .locked-content {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        .unlocked .locked-content {
            filter: none;
            pointer-events: auto;
            user-select: auto;
        }

        /* Tabs System */
        .tabs-header {
            display: flex;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--glass-border);
            padding: 0 20px;
            overflow-x: auto;
            scrollbar-width: none;
            /* Firefox */
        }

        .tabs-header::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            transition: 0.3s;
            flex: none;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
            transform: none !important;
            box-shadow: none !important;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Maps Search styles */
        .maps-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .maps-item {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .maps-item:last-child {
            border-bottom: none;
        }

        .maps-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .maps-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* QR Code Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            max-width: 400px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        .qr-placeholder {
            width: 250px;
            height: 250px;
            background: white;
            margin: 20px auto;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .qr-placeholder img {
            width: 100%;
            height: 100%;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <div id="qrModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeQRModal()">&times;</span>
            <h3 style="color: var(--primary); margin-bottom: 10px;">Conectar WhatsApp</h3>
            <p style="font-size: 13px; color: var(--text-muted);">Abra o WhatsApp > Configura√ß√µes > Aparelhos Conectados
                > Conectar um Aparelho</p>

            <div class="qr-placeholder" id="qrContainer">
                <div style="color: #000; font-size: 12px;">Gerando QR Code...</div>
            </div>

            <div id="connectionStatus" style="font-size: 14px; font-weight: 600; margin-top: 15px;">
                ‚è≥ Aguardando leitura...
            </div>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1 id="title-main">MG Sender <span style="font-weight: 300; opacity: 0.5;">v2.0</span></h1>
            <p>DESIGN PREMIUM &bull; DISPARO INTELIGENTE &bull; MULTI-M√çDIA</p>
        </div>

        <div class="tabs-header">
            <button id="btn-tab-sender" class="tab-btn active" onclick="switchTab('sender')">üî• DISPARO EM
                MASSA</button>
            <button id="btn-tab-maps" class="tab-btn" onclick="switchTab('maps')">üìç EXTRA√á√ÉO MAPS</button>
            <button id="btn-tab-groups" class="tab-btn" onclick="switchTab('groups')">üë• EXTRA√á√ÉO GRUPOS</button>

        </div>

        <!-- Tab 1: MG Sender -->
        <div id="tab-sender" class="tab-pane active">
            <div class="content">
                <!-- Coluna 1: Configura√ß√µes e Arquivos -->
                <div class="column">
                    <!-- CONFIGURA√á√ÉO N√çVEL 1: WEBHOOK E INST√ÇNCIA (SENHA: magnogomes) -->
                    <div class="config-section" style="position: relative; overflow: hidden; margin-bottom: 20px;"
                        id="configSectionUser">
                        <div id="loginOverlay" class="login-overlay">
                            <div class="login-box">
                                <h3>üîê Conex√£o do Usu√°rio</h3>
                                <input type="password" id="passLogin" placeholder="Senha de Acesso"
                                    style="width: 100%; padding: 12px 14px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; color: white; margin-bottom: 12px;">
                                <button class="btn-login" onclick="checkLogin()">LIBERAR ACESSO</button>
                            </div>
                        </div>
                        <div class="locked-content">
                            <h2>‚öôÔ∏è Conex√£o & Inst√¢ncia</h2>
                            <div class="form-group">
                                <label>Webhook URL (N8N)</label>
                                <input type="text" id="n8nWebhook" placeholder="Sua URL do Webhook"
                                    value="https://n8n.naturaisterravida.com.br/webhook/disparo-whatsapp">
                            </div>
                            <div id="connectionPanel"
                                style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center;">

                                <div id="statusBadge"
                                    style="display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-bottom: 15px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2);">
                                    üî¥ N√ÉO CONECTADO
                                </div>

                                <!-- Campo de Inst√¢ncia Tornado Vis√≠vel -->
                                <div style="margin-bottom: 15px; text-align: left;">
                                    <label style="font-size: 11px;">Nome da Inst√¢ncia (Sess√£o)</label>
                                    <div style="display: flex; gap: 5px;">
                                        <input type="text" id="instanceName" value="assessor_prosperazap"
                                            placeholder="Ex: mg_12345"
                                            style="text-align: center; font-weight: bold; color: var(--primary); flex: 1;">
                                        <button onclick="generateNewInstance()"
                                            style="padding: 5px 10px; font-size: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);"
                                            title="Gerar Novo Nome">üîÑ</button>
                                    </div>
                                </div>

                                <h3 id="instanceDisplay" style="font-size: 14px; margin-bottom: 15px; display: none;">
                                    Sess√£o: <span style="color: var(--primary);">---</span></h3>

                                <div style="display: flex; flex-direction: column; gap: 10px;">
                                    <button id="btnConnect" class="btn-primary" onclick="startQRConnection()"
                                        style="width: 100%;">
                                        üì≤ CONECTAR WHATSAPP
                                    </button>

                                    <button id="btnLogout" onclick="forceLogout()"
                                        style="width: 100%; padding: 10px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); font-size: 12px; border-radius: 12px; cursor: pointer;">
                                        ‚ö†Ô∏è DESCONECTAR / SAIR
                                    </button>
                                </div>

                                <p style="font-size: 11px; color: var(--text-muted); margin-top: 10px;">
                                    Use "Desconectar" se o QR Code n√£o aparecer ou se quiser trocar de conta.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- CONFIGURA√á√ÉO N√çVEL 2: API KEY (SENHA: 212003) -->
                    <div class="config-section" style="position: relative; overflow: hidden; margin-bottom: 20px;"
                        id="configSectionMaster">
                        <div id="masterOverlay" class="login-overlay">
                            <div class="login-box">
                                <h3>üîë Chave de API Master</h3>
                                <input type="password" id="passMaster" placeholder="Senha Master"
                                    style="width: 100%; padding: 12px 14px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; color: white; margin-bottom: 12px;">
                                <button class="btn-login" onclick="unlockMasterData()"
                                    style="background: var(--accent); color: white;">REVELAR API KEY</button>
                            </div>
                        </div>
                        <div class="locked-content">
                            <h2>üõ°Ô∏è Seguran√ßa Evolution</h2>
                            <div class="form-group">
                                <label>API Key Evolution (Master)</label>
                                <input type="text" id="apiKey" placeholder="Chave API"
                                    value="f98fed17beccac0149db6cfe6bfb7fff">
                            </div>
                        </div>
                    </div>

                    <div class="config-section" style="margin-top: 20px;">
                        <h2>üìã Lista de Clientes</h2>
                        <div class="file-upload-wrapper">
                            <input type="file" id="excelFile" accept=".xlsx,.xls">
                            <div class="file-upload-info">
                                <div class="icon-plus">üìÅ</div>
                                <span id="fileNameDisplay">Arraste seu Excel ou clique aqui</span>
                                <span style="opacity: 0.5; font-size: 11px;">(Colunas recomendadas: Nome,
                                    Telefone)</span>
                            </div>
                        </div>

                        <div class="preview-section" id="previewSection" style="display: none; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px; color: var(--primary);">Total: <strong
                                        id="totalContacts">0</strong></span>
                                <label
                                    style="margin: 0; display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" checked>
                                    <span style="font-size: 12px;">Todos</span>
                                </label>
                            </div>
                            <div class="preview-list" id="previewList"></div>
                        </div>
                    </div>
                </div>

                <!-- Coluna 2: Mensagem e M√≠dia -->
                <div class="column">
                    <div class="config-section">
                        <h2>üí¨ Mensagem Personalizada</h2>
                        <div class="form-group">
                            <label>Sua Mensagem</label>
                            <textarea id="message"
                                placeholder="Ol√° {nome}, seu vencimento no dia {vencimento} est√° pr√≥ximo..."></textarea>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                <div class="variable-tips" id="variableTips">
                                    <span class="variable-pill" onclick="insertVar('{nome}')">{nome}</span>
                                </div>
                                <span style="font-size: 11px; color: var(--text-muted);"><span id="charCount">0</span>
                                    caracteres</span>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <label>Anexar M√≠dia (Imagem/PDF/V√≠deo)</label>
                            <div class="file-upload-wrapper" style="padding: 10px;">
                                <input type="file" id="mediaFile"
                                    accept="image/*,application/pdf,video/*,audio/mpeg,audio/ogg">
                                <span id="mediaNameDisplay" style="font-size: 12px; color: var(--text-muted);">Clique
                                    para
                                    anexar arquivo</span>
                            </div>
                            <label style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="isAudio" style="width: auto;">
                                <span style="font-size: 12px;">Enviar como √Åudio Gravado (apenas .mp3/.ogg)</span>
                            </label>
                        </div>
                    </div>

                    <div class="config-section" style="margin-top: 20px;">
                        <h2>‚è∞ Agendamento</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="date" id="scheduleDate">
                            <input type="time" id="scheduleTime">
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label>Delay entre Texto e M√≠dia (segundos)</label>
                            <input type="number" id="msgDelay" value="3" min="0" max="60"
                                style="width: 100%; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); color: white; border-radius: 8px;">
                        </div>
                    </div>
                </div>

                <div class="progress-container" id="progressContainer">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 11px;">
                        <span id="progressStatus">Enviando...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-danger" style="flex: 0.3;" onclick="limparFormulario()">LIMPAR</button>
                    <button class="btn-accent"
                        style="flex: 0.3; background: #1D6F42; color: white; border: 1px solid rgba(255,255,255,0.1);"
                        onclick="exportToExcel(contatosData, 'lista_final_disparo')">üìä EXCEL</button>
                    <button class="btn-accent" id="btnSchedule" onclick="agendarDisparo()">AGENDAR DISPARO</button>
                    <button class="btn-primary" id="btnSend" onclick="iniciarDisparo()">üî• DISPARO IMEDIATO</button>
                </div>
            </div>
        </div>

        <!-- Tab 2: Google Maps Leads -->
        <div id="tab-maps" class="tab-pane">
            <div class="content" style="grid-template-columns: 1fr;">
                <div class="config-section">
                    <h2>üìç Extra√ß√£o de Leads Google Maps</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <div style="flex: 1;">
                            <label>O que voc√™ procura? (Ex: Dentistas em S√£o Paulo)</label>
                            <input type="text" id="mapsQuery" placeholder="Ex: Pet Shops em Curitiba">
                        </div>
                        <div style="align-self: flex-end; margin-bottom: 18px;">
                            <button class="btn-primary" onclick="searchMaps()" id="btnMapsSearch">üîç BUSCAR
                                LEADS</button>
                        </div>
                    </div>

                    <div id="mapsResultsCount" style="font-size: 13px; color: var(--primary); display: none;">
                        Encontrados: <strong id="totalMapsLeads">0</strong> leads
                    </div>

                    <div class="maps-results" id="mapsResultsList">
                        <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                            Fa√ßa uma busca para carregar leads do Google Maps
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn-primary" onclick="importLeadsToSender()" id="btnImportLeads" disabled>üì•
                            IMPORTAR SELECIONADOS PARA O DISPARO</button>
                        <button class="btn-accent" onclick="exportToExcel(mapsLeads, 'leads_google_maps')">üìä EXPORTAR
                            EXCEL</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Extra√ß√£o Grupos WhatsApp -->
        <div id="tab-groups" class="tab-pane">
            <div class="content">
                <div class="config-section" style="grid-column: span 2;">
                    <h2>üë• Meus Grupos do WhatsApp</h2>
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">
                        Carregue os grupos onde voc√™ est√° e extraia todos os participantes.
                    </p>

                    <!-- Configura√ß√£o de API Alternativa -->
                    <div
                        style="background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="font-size: 14px; margin: 0; color: #ffc107;">‚öôÔ∏è UazAPI (Fallback Seguro)</h3>
                            <button onclick="unlockUazConfig()"
                                style="background: none; border: 1px solid #ffc107; color: #ffc107; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">üîí
                                Editar</button>
                        </div>

                        <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 10px;">
                            Configura√ß√£o protegida para extra√ß√£o de grupos restritos.
                        </p>

                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="font-size: 12px;">URL da UazAPI</label>
                                <input type="text" id="extractionApiUrl" value="https://prosperazap.uazapi.com" readonly
                                    style="width: 100%; padding: 8px; background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); color: #aaa; border-radius: 5px; font-size: 12px;">
                            </div>
                            <!-- Ocultando subdom√≠nio pois n√£o √© usado na UazAPI direta -->
                            <div style="display:none;">
                                <label style="font-size: 12px;">Subdom√≠nio</label>
                                <input type="text" id="extractionInstance" value="default" readonly
                                    style="width: 100%; padding: 8px; background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); color: #aaa; border-radius: 5px; font-size: 12px;">
                            </div>
                            <div style="grid-column: span 2;">
                                <label style="font-size: 12px;">Token da Inst√¢ncia</label>
                                <input type="password" id="extractionApiKey"
                                    value="440ecac3-306c-4bdd-b14f-3c8e956830cd" readonly
                                    style="width: 100%; padding: 8px; background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); color: #aaa; border-radius: 5px; font-size: 12px;">
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                            <input type="checkbox" id="useAlternativeApi" style="width: auto;">
                            <label for="useAlternativeApi" style="font-size: 12px; margin: 0;">Usar UazAPI para
                                extra√ß√£o de grupos</label>
                        </div>
                    </div>

                    <button class="btn-primary" onclick="fetchGroups()" style="width: auto; margin-bottom: 20px;">
                        üîÑ CARREGAR MEUS GRUPOS
                    </button>

                    <div id="groupsList" class="maps-results" style="display: none; max-height: 500px;">
                        <!-- Lista de Grupos -->
                    </div>

                    <div id="groupLoading"
                        style="display: none; text-align: center; padding: 20px; color: var(--primary);">
                        ‚è≥ Extraindo contatos do grupo... Aguarde...
                    </div>
                </div>
            </div>
        </div>


    </div>

    <div class="status-toast" id="statusToast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let contatosData = [];
        let base64Media = null;
        let mediaFileName = null;
        let mediaMimeType = null;

        // Carregar configura√ß√µes salvas
        window.addEventListener('load', () => {
            const savedWebhook = localStorage.getItem('mg_webhook');
            const savedKey = localStorage.getItem('mg_apikey');
            const savedInstance = localStorage.getItem('mg_instance');
            const savedInstaWebhook = localStorage.getItem('mg_insta_webhook');

            if (savedWebhook) document.getElementById('n8nWebhook').value = savedWebhook;
            if (savedKey) document.getElementById('apiKey').value = savedKey;
            if (savedInstaWebhook) document.getElementById('instaWebhook').value = savedInstaWebhook;

            if (savedInstance) {
                document.getElementById('instanceName').value = savedInstance;
                updateConnectionUI(savedInstance);
                checkInstanceStatus(savedInstance);
            }
        });

        function updateConnectionUI(instance) {
            document.getElementById('instanceDisplay').style.display = 'block';
            document.getElementById('instanceDisplay').querySelector('span').textContent = instance;
            document.getElementById('btnConnect').textContent = "üîÑ RECONECTAR / TROCAR";
        }

        async function checkInstanceStatus(instance) {
            const apiKey = document.getElementById('apiKey').value || 'f98fed17beccac0149db6cfe6bfb7fff';
            try {
                const res = await fetch(`${EVOLUTION_URL}/instance/connectionState/${instance}`, {
                    headers: { 'apikey': apiKey }
                });
                const data = await res.json();
                const badge = document.getElementById('statusBadge');

                if (data.instance && data.instance.state === "open") {
                    badge.innerHTML = "üü¢ WHATSAPP CONECTADO";
                    badge.style.background = "rgba(37, 211, 102, 0.1)";
                    badge.style.color = "var(--primary)";
                    badge.style.borderColor = "rgba(37, 211, 102, 0.2)";
                }
            } catch (e) { console.log("Erro status:", e); }
        }

        function saveConfig() {
            localStorage.setItem('mg_webhook', document.getElementById('n8nWebhook').value);
            localStorage.setItem('mg_apikey', document.getElementById('apiKey').value);
            localStorage.setItem('mg_instance', document.getElementById('instanceName').value);
        }

        // L√≥gica de Login
        function checkLogin() {
            const pass = document.getElementById('passLogin').value;

            if (pass === 'magnogomes') {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('configSectionUser').classList.add('unlocked');
                showToast('Acesso √† Conex√£o liberado!');
            } else {
                showToast('Senha de Acesso incorreta.', 'error');
            }
        }

        function unlockMasterData() {
            const pass = document.getElementById('passMaster').value;

            if (pass === '212003') {
                document.getElementById('masterOverlay').classList.add('hidden');
                document.getElementById('configSectionMaster').classList.add('unlocked');
                showToast('API Key Master liberada!');
            } else {
                showToast('Senha Master incorreta!', 'error');
            }
        }

        // Contador e Auto-resize
        document.getElementById('message').addEventListener('input', function () {
            document.getElementById('charCount').textContent = this.value.length;
        });

        function insertVar(v) {
            const area = document.getElementById('message');
            area.value += v;
            area.focus();
        }

        // Valida√ß√£o e Limpeza de Telefone
        function limparTelefone(tel) {
            if (!tel) return "";
            // Remove tudo que n√£o √© n√∫mero
            let clean = String(tel).replace(/\D/g, "");

            // Se o n√∫mero n√£o come√ßar com 55 e tiver 10 ou 11 d√≠gitos, adiciona 55
            if (clean.length >= 10 && clean.length <= 11 && !clean.startsWith("55")) {
                clean = "55" + clean;
            }

            return clean;
        }

        // Processar Excel com Multi-Vari√°veis
        document.getElementById('excelFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('fileNameDisplay').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length > 0) {
                        // Detectar colunas para vari√°veis
                        const columns = Object.keys(jsonData[0]);
                        const tips = document.getElementById('variableTips');
                        tips.innerHTML = columns
                            .filter(c => !c.toLowerCase().includes('telefone'))
                            .map(c => `<span class="variable-pill" onclick="insertVar('{${c}}')">{${c}}</span>`)
                            .join('');

                        contatosData = jsonData.map(row => {
                            // Encontrar coluna de telefone de forma inteligente
                            const telKey = columns.find(c => {
                                const lower = c.toLowerCase();
                                return lower.includes('tel') || lower.includes('cel') || lower.includes('fone') || lower.includes('whats') || lower.includes('number');
                            }) || columns[0];

                            // Encontrar coluna de nome de forma inteligente
                            const nomeKey = columns.find(c => {
                                const lower = c.toLowerCase();
                                return lower.includes('nome') || lower.includes('name') || lower.includes('lead') || lower.includes('cliente') || lower.includes('contato');
                            });

                            const phone = limparTelefone(row[telKey]);
                            const nomeEncontrado = nomeKey ? row[nomeKey] : null;

                            return { ...row, _telefone_limpo: phone, _nome_exibicao: nomeEncontrado };
                        }).filter(c => c._telefone_limpo);

                        mostrarPreview();
                        showToast(`Sucesso: ${contatosData.length} contatos carregados.`);
                    }
                } catch (error) {
                    showToast('Erro ao processar Excel: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Convers√£o de M√≠dia para Base64
        document.getElementById('mediaFile').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) {
                base64Media = null;
                return;
            }
            document.getElementById('mediaNameDisplay').textContent = file.name;
            mediaFileName = file.name;
            mediaMimeType = file.type;

            const reader = new FileReader();
            reader.onload = function (e) {
                const fullBase64 = e.target.result;
                base64Media = fullBase64.split(',')[1];
            };
            reader.readAsDataURL(file);
        });

        function mostrarPreview() {
            if (contatosData.length === 0) return;
            const previewSection = document.getElementById('previewSection');
            previewSection.style.display = 'block';
            document.getElementById('totalContacts').textContent = contatosData.length;

            const previewList = document.getElementById('previewList');
            previewList.innerHTML = contatosData.map((c, i) => `
                <div class="preview-item">
                    <input type="checkbox" class="contact-checkbox" data-index="${i}" checked>
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-weight: 600;">${c._nome_exibicao || 'Sem Nome'}</span>
                        <span style="font-size: 11px; opacity: 0.7;">+${c._telefone_limpo}</span>
                    </div>
                </div>
            `).join('');
        }

        function toggleSelectAll() {
            const state = document.getElementById('selectAll').checked;
            document.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = state);
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('statusToast');
            toast.textContent = msg;
            toast.style.borderColor = type === 'success' ? 'var(--primary)' : '#ef4444';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 4000);
        }

        async function iniciarDisparo() {
            const webhookUrl = document.getElementById('n8nWebhook').value.trim();
            const msgTemplate = document.getElementById('message').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const instanceName = document.getElementById('instanceName').value.trim();
            const msgDelay = document.getElementById('msgDelay').value || 3;
            const selectedBoxes = Array.from(document.querySelectorAll('.contact-checkbox:checked'));
            const isAudio = document.getElementById('isAudio').checked;

            if (!webhookUrl || !msgTemplate || selectedBoxes.length === 0) {
                showToast('Preencha os campos obrigat√≥rios e selecione contatos.', 'error');
                return;
            }

            saveConfig(); // Salva as chaves antes de enviar

            const btn = document.getElementById('btnSend');
            btn.disabled = true;
            document.getElementById('progressContainer').style.display = 'block';

            const total = selectedBoxes.length;
            let count = 0;
            let erros = 0;

            // DELAY DE 10 SEGUNDOS ENTRE CADA LEAD
            const DELAY_ENTRE_ENVIOS = 10000; // 10 segundos em milissegundos

            // Fun√ß√£o auxiliar para aguardar
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            for (const box of selectedBoxes) {
                const index = box.dataset.index;
                const contato = contatosData[index];

                let mensagemFinal = msgTemplate;
                Object.keys(contato).forEach(key => {
                    // Usa split/join para substituir todas as ocorr√™ncias de forma segura (sem Regex)
                    // Isso evita o erro "Nothing to repeat" se a chave for num√©rica
                    const variavel = `{${key}}`;
                    mensagemFinal = mensagemFinal.split(variavel).join(contato[key]);
                });

                const payload = {
                    number: contato._telefone_limpo,
                    telefone: contato._telefone_limpo, // Adicionado para compatibilidade com n8n antigo
                    message: mensagemFinal,
                    media: base64Media,
                    mediaName: mediaFileName,
                    mimeType: mediaMimeType,
                    isAudio: isAudio,
                    apiKey: apiKey,
                    instance: instanceName,
                    delay: msgDelay,
                    contatoInfo: contato
                };

                try {
                    // Adiciona timeout de 30 segundos para o fetch
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);

                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                    }

                    count++;
                    updateProgress(count, total);
                    console.log(`[SUCESSO] Contato ${index}: Enviado com sucesso.`);
                } catch (e) {
                    console.error(`[ERRO] Falha ao enviar para ${contato._telefone_limpo}:`, e);
                    erros++;

                    // Atualiza status visualmente para usu√°rio saber que houve erro neste item (opcional, se tivesse lista detalhada)
                    showToast(`Erro no envio para ${contato._nome_exibicao || contato._telefone_limpo}: ${e.message}`, 'error');
                }

                // AGUARDA 10 SEGUNDOS ANTES DO PR√ìXIMO ENVIO (exceto no √∫ltimo)
                if (count + erros < total) {
                    // Mostra contagem regressiva no status do progresso
                    for (let seg = 10; seg > 0; seg--) {
                        document.getElementById('progressStatus').textContent = `‚è≥ Aguardando ${seg}s antes do pr√≥ximo envio... (${count}/${total})`;
                        await delay(1000);
                    }
                }
            }

            if (erros === 0) {
                showToast(`‚úÖ Disparo Finalizado! ${count} enviados com sucesso.`);
            } else {
                showToast(`‚ö†Ô∏è Disparo conclu√≠do: ${count} enviados, ${erros} erros.`, 'error');
            }
            btn.disabled = false;
        }

        function updateProgress(curr, tot) {
            const p = (curr / tot) * 100;
            document.getElementById('progressFill').style.width = p + '%';
            document.getElementById('progressPercent').textContent = Math.round(p) + '%';
            document.getElementById('progressStatus').textContent = `Enviando ${curr} de ${tot}...`;
        }

        function limparFormulario() {
            if (confirm("Deseja realmente limpar tudo?")) {
                location.reload();
            }
        }

        function agendarDisparo() {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            if (!date || !time) {
                showToast("Selecione data e hora para agendar.", "error");
                return;
            }
            showToast(`Agendado com sucesso para ${date} √†s ${time}! (Mantenha esta aba aberta)`);

            const targetTime = new Date(`${date}T${time}`).getTime();
            const check = setInterval(() => {
                if (Date.now() >= targetTime) {
                    clearInterval(check);
                    iniciarDisparo();
                }
            }, 30000);
        }

        // --- QR CODE & CONNECTION LOGIC ---
        let statusInterval = null;
        const EVOLUTION_URL = 'https://evolution.naturaisterravida.com.br';

        async function startQRConnection() {
            let instance = document.getElementById('instanceName').value;
            const apiKey = document.getElementById('apiKey').value;

            // Se n√£o tiver inst√¢ncia, gera uma aleat√≥ria autom√°tica
            if (!instance) {
                instance = 'mg_' + Math.random().toString(36).substring(2, 9);
                document.getElementById('instanceName').value = instance;
                saveConfig();
            }

            if (!apiKey) return showToast("Chave API master n√£o configurada.", "error");

            document.getElementById('qrModal').style.display = 'flex';
            document.getElementById('qrContainer').innerHTML = '<div style="color: #000; font-size: 12px; text-align: center;">Configurando inst√¢ncia...</div>';
            document.getElementById('connectionStatus').textContent = "‚è≥ Preparando servidor...";

            try {
                // 1. Tentar criar inst√¢ncia (ignoramos erros de 'j√° existe')
                const createRes = await fetch(`${EVOLUTION_URL}/instance/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'apikey': apiKey },
                    body: JSON.stringify({
                        instanceName: instance,
                        token: apiKey,
                        qrcode: true,
                        integration: 'WHATSAPP-BAILEYS'
                    })
                });

                // Pequeno delay para o servidor processar a cria√ß√£o
                await new Promise(r => setTimeout(r, 2000));

                // 2. Buscar o QR Code
                const response = await fetch(`${EVOLUTION_URL}/instance/connect/${instance}`, {
                    headers: { 'apikey': apiKey }
                });
                const data = await response.json();

                if (data.base64) {
                    document.getElementById('qrContainer').innerHTML = `<img src="${data.base64}" alt="QR Code" style="width: 100%; height: 100%; object-fit: contain;">`;
                    document.getElementById('connectionStatus').textContent = "üì∏ Escaneie o c√≥digo acima";
                    startStatusPolling(instance, apiKey);
                } else if (data.status === "open" || (data.instance && data.instance.state === "open")) {
                    document.getElementById('qrContainer').innerHTML = '<div style="color: #000; font-size: 40px; display: flex; align-items: center; justify-content: center; height: 100%;">‚úÖ</div>';
                    document.getElementById('connectionStatus').textContent = "‚úÖ WhatsApp j√° conectado!";
                    updateConnectionUI(instance);
                    checkInstanceStatus(instance);
                    setTimeout(closeQRModal, 2000);
                } else {
                    console.error("Erro detalhado da API:", data);
                    const errorMsg = data.message || data.error || data.msg || "Erro desconhecido no servidor";
                    document.getElementById('qrContainer').innerHTML = `<div style="color: #000; font-size: 11px; padding: 20px; word-break: break-all;">O servidor n√£o retornou o QR Code.<br><br><b>Mensagem:</b> ${errorMsg}<br><br><b>Dica:</b> Tente um nome diferente de inst√¢ncia ou verifique se a API Key Master est√° correta.</div>`;
                    document.getElementById('connectionStatus').textContent = "‚ö†Ô∏è Erro na Resposta";
                }

            } catch (err) {
                console.error("Erro na conex√£o:", err);
                document.getElementById('qrContainer').innerHTML = `<div style="color: #000; font-size: 11px; padding: 20px;">Falha na rede ou servidor offline.<br><br>${err.message}</div>`;
                document.getElementById('connectionStatus').textContent = "‚ùå Falha de Rede";
            }
        }

        function startStatusPolling(instance, apiKey) {
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${EVOLUTION_URL}/instance/connectionState/${instance}`, {
                        headers: { 'apikey': apiKey }
                    });
                    const data = await res.json();

                    if (data.instance.state === "open") {
                        clearInterval(statusInterval);
                        document.getElementById('connectionStatus').textContent = "‚úÖ CONECTADO!";
                        document.getElementById('connectionStatus').style.color = "var(--primary)";
                        showToast("WhatsApp pareado com sucesso!");
                        updateConnectionUI(instance);
                        checkInstanceStatus(instance);
                        setTimeout(closeQRModal, 2000);
                    }
                } catch (e) {
                    console.error("Erro no polling:", e);
                }
            }, 3000);
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
            if (statusInterval) clearInterval(statusInterval);
        }

        // Global processContacts function to be used by all tabs
        function processContacts(data) {
            contatosData = data; // Atualiza a vari√°vel global
            document.getElementById('previewList').innerHTML = '';

            // Se vazio
            if (data.length === 0) return;

            // Detectar colunas para vari√°veis (mesma l√≥gica do excel)
            const columns = Object.keys(data[0]);
            const tips = document.getElementById('variableTips');
            // Apenas recria as dicas se elas n√£o existirem ou se for uma nova importa√ß√£o diferente
            if (tips) {
                tips.innerHTML = columns
                    .filter(c => !c.toLowerCase().includes('telefone') && !c.startsWith('_'))
                    .map(c => `<span class="variable-pill" onclick="insertVar('{${c}}')">{${c}}</span>`)
                    .join('');
            }

            // Renderiza a lista
            const previewList = document.getElementById('previewList');
            previewList.innerHTML = contatosData.map((c, i) => `
                <div class="preview-item">
                    <input type="checkbox" class="contact-checkbox" data-index="${i}" checked>
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-weight: 600;">${c._nome_exibicao || c.Nome || 'Sem Nome'}</span>
                        <span style="font-size: 11px; opacity: 0.7;">+${c._telefone_limpo}</span>
                    </div>
                </div>
            `).join('');

            mostrarPreview();
        }

        // --- WHATSAPP GROUPS LOGIC ---

        // Fun√ß√£o auxiliar para obter configura√ß√µes da API de extra√ß√£o
        function getExtractionApiConfig() {
            const checkbox = document.getElementById('useAlternativeApi');
            const useAlternative = checkbox.checked;

            console.log("=== VERIFICA√á√ÉO DE CONFIGURA√á√ÉO ===");
            console.log("Checkbox UazAPI est√° marcado?", useAlternative);

            if (useAlternative) {
                const url = document.getElementById('extractionApiUrl').value;
                const instance = document.getElementById('extractionInstance').value || 'default';
                const token = document.getElementById('extractionApiKey').value;

                if (!url || !token) {
                    showToast("Configure a URL e o Token da UazAPI!", "error");
                    return null;
                }

                return {
                    url: url.replace(/\/$/, ''), // Remove barra final se houver
                    instance,
                    token: token,  // UazAPI usa 'token' no header
                    isUazApi: true,
                    headerName: 'token'  // Nome do header
                };
            } else {
                const instance = document.getElementById('instanceName').value;
                const apiKey = document.getElementById('apiKey').value;

                if (!instance || !apiKey) {
                    showToast("Conecte seu WhatsApp primeiro na aba de Disparo.", "error");
                    return null;
                }

                return {
                    url: EVOLUTION_URL,
                    instance,
                    token: apiKey,  // Evolution usa 'apikey' mas armazenamos como token
                    isUazApi: false,
                    headerName: 'apikey'  // Nome do header
                };
            }
        }

        async function fetchGroups() {
            const config = getExtractionApiConfig();
            if (!config) return;

            document.getElementById('groupsList').style.display = 'block';
            document.getElementById('groupsList').innerHTML = '<div style="padding:20px; text-align:center;">‚è≥ Buscando grupos...</div>';

            try {
                const apiInfo = config.isUazApi ? ' (via UazAPI)' : '';
                console.log(`Buscando grupos${apiInfo}...`);
                console.log("=== DEBUG CONFIGURA√á√ÉO ===");
                console.log("URL:", config.url);
                console.log("Instance:", config.instance);
                console.log("Header Name:", config.headerName);
                console.log("Token (primeiros 10 chars):", config.token.substring(0, 10) + "...");

                // UazAPI usa /group/list, Evolution usa /group/fetchAllGroups
                const endpoint = config.isUazApi
                    ? `/group/list?noparticipants=true&force=true`
                    : `/group/fetchAllGroups/${config.instance}?getParticipants=false`;

                const fullUrl = `${config.url}${endpoint}`;
                console.log("URL completa:", fullUrl);

                // Monta headers din√¢micos
                const headers = {};
                headers[config.headerName] = config.token;
                console.log("Headers:", headers);

                const res = await fetch(fullUrl, { headers });
                console.log("Status da resposta:", res.status);

                const data = await res.json();
                console.log("Dados recebidos (RAW):", data);

                // Normaliza os dados
                let groupsList = [];

                if (Array.isArray(data)) {
                    console.log("Formato detectado: Array direto");
                    groupsList = data;
                } else if (data && Array.isArray(data.groups)) {
                    console.log("Formato detectado: Objeto com propriedade .groups");
                    groupsList = data.groups;
                } else if (data && Array.isArray(data.response)) {
                    console.log("Formato detectado: Objeto com propriedade .response");
                    groupsList = data.response;
                } else if (data && Array.isArray(data.data)) {
                    console.log("Formato detectado: Objeto com propriedade .data");
                    groupsList = data.data;
                }

                console.log(`Total de grupos extra√≠dos: ${groupsList.length}`);
                if (groupsList.length > 0) {
                    console.log("Exemplo do primeiro grupo:", groupsList[0]);
                }

                if (groupsList.length > 0) {
                    renderGroups(groupsList);
                    if (config.isUazApi) {
                        showToast(`‚úì ${groupsList.length} grupos carregados via UazAPI!`);
                    }
                } else if (data.error) {
                    console.error("Erro da API:", data.error);
                    document.getElementById('groupsList').innerHTML = `<div style="padding:20px; text-align:center;">‚ùå Erro da API: ${data.error}</div>`;
                } else {
                    console.warn("Nenhum grupo encontrado nos dados. Estrutura desconhecida.");
                    document.getElementById('groupsList').innerHTML = '<div style="padding:20px; text-align:center;">‚ùå Nenhum grupo encontrado.<br><small>Verifique o console para debugar a estrutura.</small></div>';
                }
            } catch (e) {
                console.error("=== ERRO COMPLETO ===");
                console.error("Mensagem:", e.message);
                console.error("Stack:", e.stack);
                console.error("Erro completo:", e);
                document.getElementById('groupsList').innerHTML = `<div style="padding:20px; text-align:center;">‚ùå Erro: ${e.message}<br><small>Veja o console (F12) para detalhes</small></div>`;
            }
        }

        function renderGroups(groups) {
            const list = document.getElementById('groupsList');
            list.innerHTML = '';

            console.log("Iniciando renderiza√ß√£o de grupos:", groups);

            if (!groups || groups.length === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center;">Voc√™ n√£o participa de nenhum grupo.</div>';
                return;
            }

            let renderedCount = 0;

            groups.forEach(g => {
                // Tenta encontrar ID e Nome em v√°rias propriedades poss√≠veis (Case Insensitive)
                // UazAPI costuma usar 'JID', 'jid', 'Name', 'subject' ou estrutura aninhada
                const id = g.id || g.jid || g.JID || g.groupId || (g.metadata && g.metadata.id);
                const name = g.subject || g.name || g.Name || g.newSubject || (g.metadata && g.metadata.subject) || "Grupo sem nome";

                // Se n√£o tem ID, n√£o tem como extrair
                if (!id) {
                    console.warn("Grupo ignorado (sem ID):", g);
                    return;
                }

                renderedCount++;

                const div = document.createElement('div');
                div.className = 'maps-item';
                div.innerHTML = `
                    <div class="maps-info">
                        <h4>${name}</h4>
                        <p>ID: ${id}</p>
                        <p style="color: var(--primary);">
                            ${g.participants ? g.participants.length : (g.Participants ? g.Participants.length : 'Clique para ver membros')} membros
                        </p>
                    </div>
                    <button class="btn-accent" style="width: auto; font-size: 11px; padding: 8px;" onclick="extractGroupParticipants('${id}', '${name.replace(/'/g, "\\'")}')">
                        ‚¨á EXTRAIR MEMBROS
                    </button>
                `;
                list.appendChild(div);
            });

            if (renderedCount === 0) {
                list.innerHTML = '<div style="padding:20px; text-align:center;">Grupos encontrados, mas sem ID v√°lido para exibi√ß√£o. Verifique o Console (F12).</div>';
                return;
            }

            // Op√ß√£o para exportar TODOS os grupos
            const exportBtn = document.createElement('div');
            exportBtn.className = 'button-group';
            exportBtn.style.marginTop = '20px';
            exportBtn.innerHTML = `<button class="btn-accent" onclick="exportToExcel(Array.from(document.querySelectorAll('.maps-item')).map(item => ({name: item.querySelector('h4').innerText, phone: item.querySelector('p').innerText.replace('ID: ', '')})), 'meus_grupos_whatsapp')">üìä EXPORTAR LISTA DE GRUPOS</button>`;
            list.appendChild(exportBtn);
        }

        function unlockUazConfig() {
            const pass = prompt("Digite a senha de administrador da UazAPI:");
            if (pass === "212003") {
                const fields = ['extractionApiUrl', 'extractionApiKey'];
                fields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.removeAttribute('readonly');
                        el.style.background = 'rgba(255, 255, 255, 0.1)';
                        el.style.color = '#fff';
                        el.style.border = '1px solid var(--primary)';
                    }
                });
                showToast("Edi√ß√£o liberada!");
            } else {
                alert("Senha incorreta.");
            }
        }

        async function extractGroupParticipants(groupJid, groupName) {
            let config = getExtractionApiConfig();
            if (!config) return;

            document.getElementById('groupLoading').style.display = 'block';

            // Fun√ß√£o interna para buscar dados
            const fetchData = async (conf) => {
                const headers = {};
                headers[conf.headerName] = conf.token;
                const ts = Date.now(); // Cache Buster

                try {
                    console.log(`%c [V4.1 - NO-CACHE] Iniciando busca... TS: ${ts}`, 'color: orange; font-weight: bold;');

                    if (conf.isUazApi) {
                        console.log("Tentando via UazAPI...", conf.url);
                        const res = await fetch(`${conf.url}/group/info?_t=${ts}`, {
                            method: 'POST',
                            headers: { ...headers, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ groupjid: groupJid, getInviteLink: false })
                        });
                        const d = await res.json();
                        return d.participants || d.Participants || [];
                    } else {
                        console.log("Tentando via Evolution...", conf.url);

                        // 1. Tentar endpoint v2 (Novo Padr√£o - Geralmente traz PushName)
                        try {
                            const urlV2 = `${conf.url}/group/find/${conf.instance}?groupJid=${groupJid}&_t=${ts}`;
                            console.log(`Tentando V2: ${urlV2}`);
                            const res = await fetch(urlV2, { headers, cache: 'no-store' });
                            if (res.ok) {
                                const d = await res.json();
                                const p = d.participants || (d.groupMetadata && d.groupMetadata.participants);
                                if (p && p.length > 0) {
                                    console.log(`‚úÖ SUCESSO V2! ${p.length} participantes. Exemplo:`, p[0]);
                                    return p;
                                }
                            } else {
                                console.warn(`V2 falhou (Status ${res.status}).`);
                            }
                        } catch (e) { console.warn("Erro V2:", e); }

                        // 2. Tentar endpoint v1 (Padr√£o)
                        try {
                            const urlV1 = `${conf.url}/group/findGroup/${conf.instance}?groupJid=${groupJid}&_t=${ts}`;
                            console.log(`Tentando V1: ${urlV1}`);
                            const res = await fetch(urlV1, { headers, cache: 'no-store' });
                            if (res.ok) {
                                const d = await res.json();
                                let p = d.participants || (d.data && d.data.participants);
                                if (p && p.length > 0) return p;
                            }
                        } catch (e) { console.warn("Erro V1:", e); }

                        // 3. Fallback Legacy
                        try {
                            console.log("Tentando fallback legacy...");
                            const res2 = await fetch(`${conf.url}/group/participants/${conf.instance}?groupJid=${groupJid}&_t=${ts}`, { headers, cache: 'no-store' });
                            const d2 = await res2.json();
                            return Array.isArray(d2) ? d2 : (d2.participants || []);
                        } catch (e) { console.warn("Erro Legacy:", e); }

                        return [];
                    }
                } catch (e) {
                    console.error("Erro CR√çTICO na requisi√ß√£o de participantes:", e);
                    return null;
                }
            };

            // Fun√ß√£o interna para processar e classificar
            const analyzeParticipants = async (list, conf) => {
                let reais = [];
                let lids = [];

                console.log(`üìã Processando ${list.length} participantes...`);

                for (let index = 0; index < list.length; index++) {
                    const p = list[index];

                    // DEBUG: Verificando onde est√° o nome
                    if (index < 3) console.log(`üîç DEBUG ITEM ${index}:`, p);

                    let rawId = p.id || p.jid || p.JID || (typeof p === 'string' ? p : "");
                    if (!rawId) continue;

                    let realNumber = null;

                    // Helper para normalizar propriedade
                    const phoneVal = p.phoneNumber || p.PhoneNumber;

                    // CORRE√á√ÉO CR√çTICA: Prioridade para 'phoneNumber' se existir
                    if (phoneVal && !phoneVal.includes('@lid')) {
                        realNumber = phoneVal;
                    } else if (rawId.includes('@lid')) {
                        if (p.user && !p.user.includes('@lid')) realNumber = p.user;
                        else if (p.user_id && !p.user_id.includes('@lid')) realNumber = p.user_id;
                        else if (p.phone) realNumber = p.phone;
                        else {
                            lids.push({ nome: p.notify || p.pushName || "LID", numero: rawId.split('@')[0], tipo: 'lid' });
                            continue;
                        }
                    } else {
                        realNumber = rawId.split('@')[0].split(':')[0];
                    }

                    if (realNumber) {
                        const clean = realNumber.replace(/\D/g, "");

                        // Tenta encontrar o nome em v√°rias propriedades
                        let possibleName = p.notify || p.pushName || p.name || p.Name || p.verifiedName || p.vname || p.subject || (p.contact && p.contact.name);

                        // Se n√£o encontrou nome E n√£o √© UazAPI, tenta buscar do banco de contatos
                        if (!possibleName && conf && !conf.isUazApi) {
                            try {
                                const headers = {};
                                headers[conf.headerName] = conf.token;
                                const contactRes = await fetch(`${conf.url}/chat/findContacts/${conf.instance}`, {
                                    headers,
                                    cache: 'no-store'
                                });
                                if (contactRes.ok) {
                                    const contacts = await contactRes.json();
                                    const contactData = Array.isArray(contacts) ? contacts : (contacts.data || []);
                                    const match = contactData.find(c => {
                                        const cNum = (c.id || c.jid || '').replace(/\D/g, '');
                                        return cNum === clean;
                                    });
                                    if (match) {
                                        possibleName = match.name || match.pushName || match.notify;
                                        if (possibleName) console.log(`‚úÖ Nome encontrado na agenda: ${possibleName}`);
                                    }
                                }
                            } catch (e) {
                                console.warn(`Erro ao buscar contato ${clean}:`, e);
                            }
                        }

                        // Se n√£o achar nome, usa o n√∫mero formatado para identifica√ß√£o
                        const name = possibleName || `+${clean}`;

                        reais.push({ nome: name, numero: clean, tipo: 'real' });
                    }
                }
                return { reais, lids };
            };
            try {
                showToast(`Extraindo participantes...`);
                let participants = await fetchData(config);

                if (!participants || participants.length === 0) throw new Error("API n√£o retornou participantes.");

                let { reais, lids } = await analyzeParticipants(participants, config);
                let fallbackUsed = false;
                let fallbackError = "";

                // SMART FALLBACK
                if (reais.length === 0 && lids.length > 0 && !config.isUazApi) {
                    const uazUrl = document.getElementById('extractionApiUrl').value;
                    const uazToken = document.getElementById('extractionApiKey').value;

                    if (uazUrl && uazToken) {
                        showToast("Evolution retornou mascarados. Tentando UazAPI...");
                        fallbackUsed = true;

                        const uazConfig = {
                            url: uazUrl.replace(/\/$/, ''),
                            instance: document.getElementById('extractionInstance').value || 'default',
                            token: uazToken,
                            isUazApi: true,
                            headerName: 'token'
                        };

                        const uazParticipants = await fetchData(uazConfig);
                        if (uazParticipants && uazParticipants.length > 0) {
                            const analysis = analyzeParticipants(uazParticipants);
                            // Se a UazAPI trouxe reais, usamos ela
                            if (analysis.reais.length > 0) {
                                console.log("‚úì Sucesso com UazAPI!");
                                reais = analysis.reais;
                                lids = analysis.lids;
                                config = uazConfig;
                            } else {
                                fallbackError = "UazAPI tbm s√≥ trouxe LIDs.";
                            }
                        } else {
                            fallbackError = "UazAPI falhou/vazia.";
                        }
                    } else {
                        fallbackError = "Sem credenciais UazAPI.";
                    }
                }

                // Exibe resultados
                let mensagem = `Grupo: ${groupName}\n\n`;
                mensagem += `‚úÖ N√∫meros Reais: ${reais.length}\n`;
                mensagem += `‚ö†Ô∏è IDs Mascarados: ${lids.length}\n\n`;

                if (reais.length === 0 && lids.length > 0) {
                    mensagem += `‚ö†Ô∏è AVISO: Apenas IDs mascarados encontrados.\n`;
                    if (fallbackUsed) {
                        mensagem += `(Tentativa UazAPI: ${fallbackError})\n\n`;
                    }
                    mensagem += `Deseja importar a lista de LIDs assim mesmo?`;
                } else if (reais.length > 0) {
                    mensagem += `Deseja importar os ${reais.length} contatos?`;
                } else {
                    alert("Nenhum contato encontrado.");
                    return;
                }

                if (confirm(mensagem)) {
                    if (confirm("Limpar lista atual antes de importar?")) contatosData = [];
                    const lista = reais.length > 0 ? reais : lids;
                    lista.forEach(c => {
                        contatosData.push({
                            'Nome': c.nome, 'Telefone': c.numero, '_telefone_limpo': c.numero, '_nome_exibicao': c.nome, 'Origem': groupName
                        });
                    });
                    mostrarPreview();
                    switchTab('sender');
                    showToast(`${lista.length} importados.`);
                }

            } catch (e) {
                console.error(e);
                showToast("Erro: " + e.message, "error");
            } finally {
                document.getElementById('groupLoading').style.display = 'none';
            }
        }



        // --- INSTAGRAM LOGIC (REAL VIA N8N) ---
        let instaLeads = [];

        async function searchInstagram() {
            const query = document.getElementById('instaQuery').value;
            const webhook = document.getElementById('instaWebhook').value;

            if (!query) return showToast("Digite um perfil ou hashtag.", "error");
            if (!webhook) return showToast("Configure o Webhook do n8n para Instagram primeiro.", "error");

            // Salvar para n√£o ter que digitar sempre
            localStorage.setItem('mg_insta_webhook', webhook);

            const btn = document.getElementById('btnInstaSearch');
            btn.disabled = true;
            btn.textContent = "üîç EXTRAINDO...";

            document.getElementById('instaResults').style.display = 'block';
            document.getElementById('instaResults').innerHTML = '<div style="padding:20px; text-align:center;">‚è≥ Iniciando extra√ß√£o via n8n...<br>Isso pode levar alguns minutos dependendo da quantidade de dados.</div>';

            try {
                const response = await fetch(webhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        timestamp: new Date().getTime()
                    })
                });

                if (!response.ok) throw new Error("O Webhook retornou um erro.");

                const data = await response.json();

                // Esperamos um array ou um objeto que contenha a lista
                const leads = Array.isArray(data) ? data : (data.leads || data.data || []);

                if (leads.length > 0) {
                    displayInstaResults(leads);
                    showToast(`Sucesso! ${leads.length} leads encontrados.`);
                } else {
                    document.getElementById('instaResults').innerHTML = '<div style="padding:20px; text-align:center;">‚ùå Nenhum lead com telefone encontrado para esta busca.</div>';
                }
            } catch (err) {
                console.error(err);
                document.getElementById('instaResults').innerHTML = `<div style="padding:20px; text-align:center; color: #ef4444;">‚ùå Erro na conex√£o com n8n:<br>${err.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = "üîç BUSCAR LEADS REAIS";
            }
        }

        function displayInstaResults(results) {
            const container = document.getElementById('instaResults');
            container.innerHTML = '';
            instaLeads = results;

            results.forEach((user, index) => {
                const phone = user.phone || user.telefone || user.whatsapp;
                const name = user.name || user.nome || user.username;

                const div = document.createElement('div');
                div.className = 'maps-item';
                div.innerHTML = `
                    <div class="maps-info" style="display:flex; align-items:center; gap:10px;">
                        <div style="width:40px; height:40px; background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px;">üë§</div>
                        <div>
                            <h4>@${user.username || name}</h4>
                            <p>${name}</p>
                            ${phone ? `<p style="color: var(--primary);">üìû ${phone}</p>` : '<p style="color: #ef4444;">N√∫mero n√£o encontrado</p>'}
                        </div>
                    </div>
                    <input type="checkbox" id="check-insta-${index}" ${phone ? 'checked' : 'disabled'}>
                `;
                container.appendChild(div);
            });
        }

        function importInstaLeads() {
            let count = 0;
            instaLeads.forEach((lead, index) => {
                const check = document.getElementById(`check-insta-${index}`);
                if (check && check.checked) {
                    const phone = lead.phone || lead.telefone || lead.whatsapp;
                    const name = lead.name || lead.nome || lead.username;

                    if (phone) {
                        contatosData.push({
                            'Nome': name,
                            'Telefone': phone,
                            '_telefone_limpo': limparTelefone(phone),
                            '_nome_exibicao': name
                        });
                        count++;
                    }
                }
            });

            if (count > 0) {
                mostrarPreview();
                switchTab('sender');
                showToast(`${count} leads do Instagram importados para o disparo!`);
            } else {
                showToast("Nenhum lead com telefone selecionado.", "error");
            }
        }

        // --- GOOGLE MAPS LOGIC ---
        let mapsLeads = [];
        let placesService;
        let currentPage = 1;
        const leadsPerPage = 50;

        function switchTab(tab) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            const pane = document.getElementById(`tab-${tab}`);
            const btn = document.getElementById(`btn-tab-${tab}`);

            if (pane) pane.classList.add('active');
            if (btn) btn.classList.add('active');
        }

        function initAutocomplete() {
            // Callback do Google Maps
            placesService = new google.maps.places.PlacesService(document.createElement('div'));
        }

        async function searchMaps() {
            const query = document.getElementById('mapsQuery').value;
            if (!query) return showToast("Digite o que procura.", "error");

            const btn = document.getElementById('btnMapsSearch');
            btn.disabled = true;
            btn.textContent = "üîç BUSCANDO...";

            mapsLeads = []; // Limpar anterior
            currentPage = 1; // Reset p√°gina
            renderMapsResults();

            const request = { query: query };

            placesService.textSearch(request, async (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    showToast(`Buscando detalhes de ${results.length} locais...`);

                    for (const place of results) {
                        await new Promise(resolve => {
                            placesService.getDetails({
                                placeId: place.place_id,
                                fields: ['name', 'formatted_phone_number', 'formatted_address']
                            }, (details, dStatus) => {
                                if (dStatus === google.maps.places.PlacesServiceStatus.OK && details.formatted_phone_number) {
                                    mapsLeads.push({
                                        nome: details.name,
                                        telefone: details.formatted_phone_number,
                                        address: details.formatted_address
                                    });
                                    renderMapsResults(); // Update real-time
                                }
                                // Pequeno delay para evitar Rate Limit da API do Google
                                setTimeout(resolve, 200);
                            });
                        });
                    }

                    btn.disabled = false;
                    btn.textContent = "üîç BUSCAR LEADS";
                    showToast(`Busca finalizada! ${mapsLeads.length} leads com telefone.`);
                } else {
                    btn.disabled = false;
                    btn.textContent = "üîç BUSCAR LEADS";
                    showToast("Erro na busca: " + status, "error");
                }
            });
        }

        function renderMapsResults() {
            const list = document.getElementById('mapsResultsList');
            document.getElementById('mapsResultsCount').style.display = 'block';
            document.getElementById('totalMapsLeads').textContent = mapsLeads.length;
            document.getElementById('btnImportLeads').disabled = mapsLeads.length === 0;

            if (mapsLeads.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center;">Nenhum lead com telefone encontrado.</div>';
                return;
            }

            // Calcular pagina√ß√£o
            const totalPages = Math.ceil(mapsLeads.length / leadsPerPage);
            const startIndex = (currentPage - 1) * leadsPerPage;
            const endIndex = startIndex + leadsPerPage;
            const currentLeads = mapsLeads.slice(startIndex, endIndex);

            // Renderizar leads da p√°gina atual
            let html = currentLeads.map((lead, i) => {
                const globalIndex = startIndex + i;
                return `
                <div class="maps-item">
                    <div class="maps-info">
                        <h4>${lead.nome}</h4>
                        <p>${lead.telefone} | ${lead.address || ''}</p>
                    </div>
                    <input type="checkbox" class="maps-checkbox" data-index="${globalIndex}" checked>
                </div>
            `;
            }).join('');

            // Adicionar controles de pagina√ß√£o se houver mais de 50 leads
            if (totalPages > 1) {
                html += `
                <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} 
                        style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; opacity: ${currentPage === 1 ? '0.5' : '1'};">
                        ‚Üê Anterior
                    </button>
                    
                    <div style="display: flex; gap: 5px;">
                        ${generatePageButtons(currentPage, totalPages)}
                    </div>
                    
                    <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} 
                        style="padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; opacity: ${currentPage === totalPages ? '0.5' : '1'};">
                        Pr√≥xima ‚Üí
                    </button>
                </div>
                <div style="text-align: center; margin-top: 10px; color: #888;">
                    Mostrando ${startIndex + 1}-${Math.min(endIndex, mapsLeads.length)} de ${mapsLeads.length} leads | P√°gina ${currentPage} de ${totalPages}
                </div>
                `;
            }

            list.innerHTML = html;
        }

        function generatePageButtons(current, total) {
            let buttons = '';
            const maxButtons = 5;
            let startPage = Math.max(1, current - Math.floor(maxButtons / 2));
            let endPage = Math.min(total, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                buttons += `
                    <button onclick="changePage(${i})" 
                        style="padding: 8px 12px; background: ${i === current ? 'var(--primary)' : 'rgba(255,255,255,0.1)'}; 
                        color: white; border: ${i === current ? '2px solid white' : 'none'}; 
                        border-radius: 5px; cursor: pointer; font-weight: ${i === current ? 'bold' : 'normal'};">
                        ${i}
                    </button>
                `;
            }
            return buttons;
        }

        function changePage(page) {
            const totalPages = Math.ceil(mapsLeads.length / leadsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderMapsResults();
            // Scroll para o topo da lista
            document.getElementById('mapsResultsList').scrollIntoView({ behavior: 'smooth' });
        }

        function importLeadsToSender() {
            const selectedIdx = Array.from(document.querySelectorAll('.maps-checkbox:checked')).map(cb => cb.dataset.index);
            if (selectedIdx.length === 0) return showToast("Selecione ao menos um lead.", "error");

            const imported = selectedIdx.map(idx => {
                const lead = mapsLeads[idx];
                const phone = limparTelefone(lead.telefone);
                return {
                    nome: lead.nome,
                    telefone: lead.telefone,
                    _telefone_limpo: phone,
                    _nome_exibicao: lead.nome
                };
            });

            contatosData = [...contatosData, ...imported];
            mostrarPreview();
            switchTab('sender');
            showToast(`${imported.length} leads importados para o disparo!`);
        }

        // --- EXPORT FUNCTION ---
        function exportToExcel(data, filename) {
            if (!data || data.length === 0) return showToast("Nenhum dado para exportar.", "error");

            // Formata dados para excel de forma inteligente (independente de mai√∫sculas/min√∫sculas)
            const cleanData = data.map(item => {
                // Tenta encontrar o nome em v√°rias chaves poss√≠veis
                const nome = item.Nome || item.nome || item.name || item.username || item._nome_exibicao || "";
                // Tenta encontrar o telefone em v√°rias chaves poss√≠veis
                const telefone = item.Telefone || item.telefone || item.phone || item.number || item.jid || item._telefone_limpo || "";

                return {
                    Nome: nome,
                    Telefone: telefone,
                    Origem: filename,
                    Data: new Date().toLocaleDateString()
                };
            });

            const ws = XLSX.utils.json_to_sheet(cleanData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Leads");
            XLSX.writeFile(wb, `${filename}_${new Date().getTime()}.xlsx`);
            showToast("Planilha gerada com sucesso!");
        }
        // NOVA FUN√á√ÉO: Gerar Nova Inst√¢ncia Aleat√≥ria
        function generateNewInstance() {
            const randomId = Math.random().toString(36).substring(2, 7);
            const newName = "mg_" + randomId;
            document.getElementById('instanceName').value = newName;
            // Atualiza visual
            document.getElementById('statusBadge').innerHTML = "üî¥ N√ÉO CONECTADO (NOVA)";
            document.getElementById('statusBadge').style.background = "rgba(239, 68, 68, 0.1)";
            document.getElementById('statusBadge').style.color = "#ef4444";

            showToast("Nova inst√¢ncia gerada: " + newName);
        }

        // NOVA FUN√á√ÉO: For√ßar Logout
        async function forceLogout() {
            const instance = document.getElementById('instanceName').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!instance) return showToast("Nenhuma inst√¢ncia definida.", "error");

            if (!confirm("Aten√ß√£o: Isso vai desconectar a inst√¢ncia '" + instance + "' do WhatsApp.\n\nVoc√™ ter√° que escanear o QR Code novamente.\n\nDeseja continuar?")) return;

            showToast("Tentando desconectar...", "info");

            try {
                // Tenta Logout
                const res = await fetch(`${EVOLUTION_URL}/instance/logout/${instance}`, {
                    method: 'DELETE',
                    headers: { 'apikey': apiKey }
                });

                // Tenta Deletar (caso logout n√£o baste ou API diferente)
                // Ignoramos erro se falhar, pois o logout √© o principal
                try {
                    await fetch(`${EVOLUTION_URL}/instance/delete/${instance}`, {
                        method: 'DELETE',
                        headers: { 'apikey': apiKey }
                    });
                } catch (e) { }

                // Feedback visual de sucesso (mesmo se API der erro, assumimos desconex√£o local)
                document.getElementById('statusBadge').innerHTML = "üî¥ DESCONECTADO";
                document.getElementById('statusBadge').style.background = "rgba(239, 68, 68, 0.1)";
                document.getElementById('statusBadge').style.color = "#ef4444";
                document.getElementById('qrContainer').innerHTML = "<div style='padding:20px; font-size:11px;'>Desconectado.<br>Clique em Conectar para gerar novo QR.</div>";

                alert("Comando de desconex√£o enviado.\n\nSe o erro persistir, gere uma NOVA inst√¢ncia clicando no bot√£o de 'retorno' (üîÑ) ao lado do nome da sess√£o.");

            } catch (error) {
                console.error("Erro ao desconectar:", error);
                alert("Erro ao tentar desconectar: " + error.message + "\n\nTente gerar uma nova inst√¢ncia.");
            }
        }
    </script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWIu9AMbRBq9eAZ7B_OzjBoLjfPIfiXZg&libraries=places&callback=initAutocomplete"></script>
</body>

</html>