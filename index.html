<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG Sender - WhatsApp Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --accent: #667eea;
            --accent-dark: #764ba2;
            --bg-dark: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
        }

        /* Background Effects */
        body::before {
            content: '';
            position: fixed;
            top: -10%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: var(--primary);
            filter: blur(150px);
            opacity: 0.15;
            z-index: -1;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -10%;
            left: -10%;
            width: 400px;
            height: 400px;
            background: var(--accent);
            filter: blur(150px);
            opacity: 0.15;
            z-index: -1;
        }

        .container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            max-width: 900px;
            width: 100%;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .header {
            padding: 40px 30px;
            text-align: center;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.02);
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-muted);
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        @media (max-width: 600px) {
            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 26px;
            }

            .header p {
                font-size: 13px;
            }
        }

        .content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 600px) {
            .content {
                padding: 20px;
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .config-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
        }

        .config-section h2 {
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 13px;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea {
            width: 100%;
            padding: 12px 14px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 14px;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 0 4px rgba(37, 211, 102, 0.1);
        }

        textarea {
            resize: none;
            min-height: 120px;
        }

        /* File Upload Styling */
        .file-upload-wrapper {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-upload-wrapper:hover {
            border-color: var(--primary);
            background: rgba(37, 211, 102, 0.05);
        }

        .file-upload-wrapper input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            pointer-events: none;
        }

        .file-upload-info span {
            font-size: 13px;
        }

        .icon-plus {
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* Info & Variable Pills */
        .variable-tips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .variable-pill {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: copy;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .variable-pill:hover {
            background: var(--primary);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Status & Logs */
        .preview-section {
            grid-column: span 2;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-top: 10px;
            border: 1px solid var(--glass-border);
        }

        @media (max-width: 768px) {
            .preview-section {
                grid-column: span 1;
            }
        }

        .preview-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .preview-item {
            padding: 10px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .preview-item:last-child {
            border-bottom: none;
        }

        /* Progress Bar */
        .progress-container {
            grid-column: span 2;
            display: none;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Buttons */
        .button-group {
            grid-column: span 2;
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .button-group {
                flex-direction: column;
                grid-column: span 1;
            }

            .button-group button {
                width: 100%;
            }
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: black;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2);
        }

        .btn-accent {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid var(--glass-border);
        }

        .btn-accent:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Notifications */
        .status-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 12px;
            background: #1e293b;
            border: 1px solid var(--glass-border);
            display: none;
            animation: slideUp 0.3s ease;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .media-preview-item {
            font-size: 11px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-media {
            color: #ef4444;
            cursor: pointer;
        }

        /* Login Overlay */
        .login-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border-radius: 16px;
            transition: all 0.5s ease;
        }

        .login-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-box {
            width: 100%;
            max-width: 300px;
        }

        .login-box h3 {
            margin-bottom: 20px;
            text-align: center;
            color: var(--primary);
            font-size: 18px;
        }

        .login-box input {
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-login {
            width: 100%;
            background: var(--primary);
            color: #000;
            margin-top: 10px;
        }

        .locked-content {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        .unlocked .locked-content {
            filter: none;
            pointer-events: auto;
            user-select: auto;
        }

        /* Tabs System */
        .tabs-header {
            display: flex;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--glass-border);
            padding: 0 20px;
            overflow-x: auto;
            scrollbar-width: none;
            /* Firefox */
        }

        .tabs-header::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            transition: 0.3s;
            flex: none;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
            transform: none !important;
            box-shadow: none !important;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Maps Search styles */
        .maps-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .maps-item {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .maps-item:last-child {
            border-bottom: none;
        }

        .maps-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .maps-info p {
            font-size: 12px;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 id="title-main">MG Sender <span style="font-weight: 300; opacity: 0.5;">v2.0</span></h1>
            <p>DESIGN PREMIUM &bull; DISPARO INTELIGENTE &bull; MULTI-M√çDIA</p>
        </div>

        <div class="tabs-header">
            <button id="btn-tab-sender" class="tab-btn active" onclick="switchTab('sender')">üî• DISPARO EM
                MASSA</button>
            <button id="btn-tab-maps" class="tab-btn" onclick="switchTab('maps')">üìç EXTRA√á√ÉO MAPS</button>
        </div>

        <!-- Tab 1: MG Sender -->
        <div id="tab-sender" class="tab-pane active">
            <div class="content">
                <!-- Coluna 1: Configura√ß√µes e Arquivos -->
                <div class="column">
                    <div class="config-section" style="position: relative; overflow: hidden;" id="apiConfigSection">
                        <div id="loginOverlay" class="login-overlay">
                            <div class="login-box">
                                <h3>üîê Admin Access</h3>
                                <input type="password" id="passLogin" placeholder="Senha do Administrador"
                                    style="width: 100%; padding: 12px 14px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; color: white; margin-bottom: 12px;">
                                <button class="btn-login" onclick="checkLogin()">ACESSAR PAINEL</button>
                            </div>
                        </div>
                        <div class="locked-content">
                            <div id="masterOverlay"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(10px); z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 16px; transition: 0.3s;">
                                <span style="font-size: 10px; color: var(--text-muted); margin-bottom: 8px;">DADOS
                                    SENS√çVEIS OCULTOS</span>
                                <button class="btn-primary" style="padding: 8px 15px; font-size: 12px; width: auto;"
                                    onclick="unlockMasterData()">üîì REVELAR CHAVES</button>
                            </div>
                            <h2>‚öôÔ∏è Configura√ß√µes Master</h2>
                            <div class="form-group">
                                <label>Webhook URL (Central)</label>
                                <input type="password" id="n8nWebhook" placeholder="URL n8n"
                                    value="https://n8n.naturaisterravida.com.br/webhook/conexao-limpa-v1">
                            </div>
                            <div class="form-group">
                                <label>Chave API Master (Oculta)</label>
                                <input type="password" id="apiKey" placeholder="Sua Chave"
                                    value="f98fed17beccac0149db6cfe6bfb7fff">
                            </div>
                        </div>
                    </div>

                    <div class="config-section" style="margin-top: 20px;">
                        <h2>üìã Lista de Clientes</h2>
                        <div class="file-upload-wrapper">
                            <input type="file" id="excelFile" accept=".xlsx,.xls">
                            <div class="file-upload-info">
                                <div class="icon-plus">üìÅ</div>
                                <span id="fileNameDisplay">Arraste seu Excel ou clique aqui</span>
                                <span style="opacity: 0.5; font-size: 11px;">(Colunas recomendadas: Nome,
                                    Telefone)</span>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label>Sua Inst√¢ncia Evolution</label>
                            <input type="text" id="instanceName" placeholder="Ex: minha_loja_01" value=""
                                style="background: rgba(255, 255, 255, 0.05);">
                        </div>

                        <div class="preview-section" id="previewSection" style="display: none; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px; color: var(--primary);">Total: <strong
                                        id="totalContacts">0</strong></span>
                                <label
                                    style="margin: 0; display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" checked>
                                    <span style="font-size: 12px;">Todos</span>
                                </label>
                            </div>
                            <div class="preview-list" id="previewList"></div>
                        </div>
                    </div>
                </div>

                <!-- Coluna 2: Mensagem e M√≠dia -->
                <div class="column">
                    <div class="config-section">
                        <h2>üí¨ Mensagem Personalizada</h2>
                        <div class="form-group">
                            <label>Sua Mensagem</label>
                            <textarea id="message"
                                placeholder="Ol√° {nome}, seu vencimento no dia {vencimento} est√° pr√≥ximo..."></textarea>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                <div class="variable-tips" id="variableTips">
                                    <span class="variable-pill" onclick="insertVar('{nome}')">{nome}</span>
                                </div>
                                <span style="font-size: 11px; color: var(--text-muted);"><span id="charCount">0</span>
                                    caracteres</span>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <label>Anexar M√≠dia (Imagem/PDF/V√≠deo)</label>
                            <div class="file-upload-wrapper" style="padding: 10px;">
                                <input type="file" id="mediaFile"
                                    accept="image/*,application/pdf,video/*,audio/mpeg,audio/ogg">
                                <span id="mediaNameDisplay" style="font-size: 12px; color: var(--text-muted);">Clique
                                    para
                                    anexar arquivo</span>
                            </div>
                            <label style="margin-top: 10px; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="isAudio" style="width: auto;">
                                <span style="font-size: 12px;">Enviar como √Åudio Gravado (apenas .mp3/.ogg)</span>
                            </label>
                        </div>
                    </div>

                    <div class="config-section" style="margin-top: 20px;">
                        <h2>‚è∞ Agendamento</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="date" id="scheduleDate">
                            <input type="time" id="scheduleTime">
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label>Delay entre Texto e M√≠dia (segundos)</label>
                            <input type="number" id="msgDelay" value="3" min="0" max="60"
                                style="width: 100%; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); color: white; border-radius: 8px;">
                        </div>
                    </div>
                </div>

                <div class="progress-container" id="progressContainer">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 11px;">
                        <span id="progressStatus">Enviando...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-danger" style="flex: 0.3;" onclick="limparFormulario()">LIMPAR</button>
                    <button class="btn-accent" id="btnSchedule" onclick="agendarDisparo()">AGENDAR DISPARO</button>
                    <button class="btn-primary" id="btnSend" onclick="iniciarDisparo()">üî• DISPARO IMEDIATO</button>
                </div>
            </div>
        </div>

        <!-- Tab 2: Google Maps Leads -->
        <div id="tab-maps" class="tab-pane">
            <div class="content" style="grid-template-columns: 1fr;">
                <div class="config-section">
                    <h2>üìç Extra√ß√£o de Leads Google Maps</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <div style="flex: 1;">
                            <label>O que voc√™ procura? (Ex: Dentistas em S√£o Paulo)</label>
                            <input type="text" id="mapsQuery" placeholder="Ex: Pet Shops em Curitiba">
                        </div>
                        <div style="align-self: flex-end; margin-bottom: 18px;">
                            <button class="btn-primary" onclick="searchMaps()" id="btnMapsSearch">üîç BUSCAR
                                LEADS</button>
                        </div>
                    </div>

                    <div id="mapsResultsCount" style="font-size: 13px; color: var(--primary); display: none;">
                        Encontrados: <strong id="totalMapsLeads">0</strong> leads
                    </div>

                    <div class="maps-results" id="mapsResultsList">
                        <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                            Fa√ßa uma busca para carregar leads do Google Maps
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn-primary" onclick="importLeadsToSender()" id="btnImportLeads" disabled>üì•
                            IMPORTAR SELECIONADOS PARA O DISPARO</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-toast" id="statusToast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let contatosData = [];
        let base64Media = null;
        let mediaFileName = null;
        let mediaMimeType = null;

        // Carregar configura√ß√µes salvas
        window.addEventListener('load', () => {
            const savedWebhook = localStorage.getItem('mg_webhook');
            const savedKey = localStorage.getItem('mg_apikey');
            const savedInstance = localStorage.getItem('mg_instance');

            if (savedWebhook) document.getElementById('n8nWebhook').value = savedWebhook;
            if (savedKey) document.getElementById('apiKey').value = savedKey;
            if (savedInstance) document.getElementById('instanceName').value = savedInstance;
        });

        function saveConfig() {
            localStorage.setItem('mg_webhook', document.getElementById('n8nWebhook').value);
            localStorage.setItem('mg_apikey', document.getElementById('apiKey').value);
            localStorage.setItem('mg_instance', document.getElementById('instanceName').value);
        }

        // L√≥gica de Login
        function checkLogin() {
            const pass = document.getElementById('passLogin').value;

            if (pass === 'magnogomes') {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('apiConfigSection').classList.add('unlocked');
                showToast('Painel de Configura√ß√µes Aberto!');
            } else {
                showToast('Senha do Painel incorreta.', 'error');
            }
        }

        function unlockMasterData() {
            const masterPass = prompt("Digite a Senha Master para revelar as chaves de API:");

            if (masterPass === '212003') {
                document.getElementById('masterOverlay').style.display = 'none';
                document.getElementById('n8nWebhook').type = 'text';
                document.getElementById('apiKey').type = 'text';
                showToast('Chaves Master reveladas com sucesso!');
            } else {
                showToast('Senha Master incorreta!', 'error');
            }
        }

        // Contador e Auto-resize
        document.getElementById('message').addEventListener('input', function () {
            document.getElementById('charCount').textContent = this.value.length;
        });

        function insertVar(v) {
            const area = document.getElementById('message');
            area.value += v;
            area.focus();
        }

        // Valida√ß√£o e Limpeza de Telefone
        function limparTelefone(tel) {
            if (!tel) return "";
            // Remove tudo que n√£o √© n√∫mero
            let clean = String(tel).replace(/\D/g, "");

            // Se o n√∫mero n√£o come√ßar com 55 e tiver 10 ou 11 d√≠gitos, adiciona 55
            if (clean.length >= 10 && clean.length <= 11 && !clean.startsWith("55")) {
                clean = "55" + clean;
            }

            return clean;
        }

        // Processar Excel com Multi-Vari√°veis
        document.getElementById('excelFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('fileNameDisplay').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length > 0) {
                        // Detectar colunas para vari√°veis
                        const columns = Object.keys(jsonData[0]);
                        const tips = document.getElementById('variableTips');
                        tips.innerHTML = columns
                            .filter(c => !c.toLowerCase().includes('telefone'))
                            .map(c => `<span class="variable-pill" onclick="insertVar('{${c}}')">{${c}}</span>`)
                            .join('');

                        contatosData = jsonData.map(row => {
                            // Encontrar coluna de telefone de forma inteligente
                            const telKey = columns.find(c => {
                                const lower = c.toLowerCase();
                                return lower.includes('tel') || lower.includes('cel') || lower.includes('fone') || lower.includes('whats') || lower.includes('number');
                            }) || columns[0];

                            // Encontrar coluna de nome de forma inteligente
                            const nomeKey = columns.find(c => {
                                const lower = c.toLowerCase();
                                return lower.includes('nome') || lower.includes('name') || lower.includes('lead') || lower.includes('cliente') || lower.includes('contato');
                            });

                            const phone = limparTelefone(row[telKey]);
                            const nomeEncontrado = nomeKey ? row[nomeKey] : null;

                            return { ...row, _telefone_limpo: phone, _nome_exibicao: nomeEncontrado };
                        }).filter(c => c._telefone_limpo);

                        mostrarPreview();
                        showToast(`Sucesso: ${contatosData.length} contatos carregados.`);
                    }
                } catch (error) {
                    showToast('Erro ao processar Excel: ' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Convers√£o de M√≠dia para Base64
        document.getElementById('mediaFile').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) {
                base64Media = null;
                return;
            }
            document.getElementById('mediaNameDisplay').textContent = file.name;
            mediaFileName = file.name;
            mediaMimeType = file.type;

            const reader = new FileReader();
            reader.onload = function (e) {
                const fullBase64 = e.target.result;
                base64Media = fullBase64.split(',')[1];
            };
            reader.readAsDataURL(file);
        });

        function mostrarPreview() {
            if (contatosData.length === 0) return;
            const previewSection = document.getElementById('previewSection');
            previewSection.style.display = 'block';
            document.getElementById('totalContacts').textContent = contatosData.length;

            const previewList = document.getElementById('previewList');
            previewList.innerHTML = contatosData.map((c, i) => `
                <div class="preview-item">
                    <input type="checkbox" class="contact-checkbox" data-index="${i}" checked>
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-weight: 600;">${c._nome_exibicao || 'Sem Nome'}</span>
                        <span style="font-size: 11px; opacity: 0.7;">+${c._telefone_limpo}</span>
                    </div>
                </div>
            `).join('');
        }

        function toggleSelectAll() {
            const state = document.getElementById('selectAll').checked;
            document.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = state);
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('statusToast');
            toast.textContent = msg;
            toast.style.borderColor = type === 'success' ? 'var(--primary)' : '#ef4444';
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 4000);
        }

        async function iniciarDisparo() {
            const webhookUrl = document.getElementById('n8nWebhook').value.trim();
            const msgTemplate = document.getElementById('message').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const instanceName = document.getElementById('instanceName').value.trim();
            const msgDelay = document.getElementById('msgDelay').value || 3;
            const selectedBoxes = Array.from(document.querySelectorAll('.contact-checkbox:checked'));
            const isAudio = document.getElementById('isAudio').checked;

            if (!webhookUrl || !msgTemplate || selectedBoxes.length === 0) {
                showToast('Preencha os campos obrigat√≥rios e selecione contatos.', 'error');
                return;
            }

            saveConfig(); // Salva as chaves antes de enviar

            const btn = document.getElementById('btnSend');
            btn.disabled = true;
            document.getElementById('progressContainer').style.display = 'block';

            const total = selectedBoxes.length;
            let count = 0;

            for (const box of selectedBoxes) {
                const index = box.dataset.index;
                const contato = contatosData[index];

                let mensagemFinal = msgTemplate;
                Object.keys(contato).forEach(key => {
                    mensagemFinal = mensagemFinal.replace(new RegExp(`{${key}}`, 'g'), contato[key]);
                });

                const payload = {
                    number: contato._telefone_limpo,
                    message: mensagemFinal,
                    media: base64Media,
                    mediaName: mediaFileName,
                    mimeType: mediaMimeType,
                    isAudio: isAudio,
                    apiKey: apiKey,
                    instance: instanceName,
                    delay: msgDelay,
                    contatoInfo: contato
                };

                try {
                    await fetch(webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    count++;
                    updateProgress(count, total);
                } catch (e) {
                    console.error("Erro no contato:", contato._telefone_limpo, e);
                }
            }

            showToast(`Disparo Finalizado! ${count} enviados.`);
            btn.disabled = false;
        }

        function updateProgress(curr, tot) {
            const p = (curr / tot) * 100;
            document.getElementById('progressFill').style.width = p + '%';
            document.getElementById('progressPercent').textContent = Math.round(p) + '%';
            document.getElementById('progressStatus').textContent = `Enviando ${curr} de ${tot}...`;
        }

        function limparFormulario() {
            if (confirm("Deseja realmente limpar tudo?")) {
                location.reload();
            }
        }

        function agendarDisparo() {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            if (!date || !time) {
                showToast("Selecione data e hora para agendar.", "error");
                return;
            }
            showToast(`Agendado com sucesso para ${date} √†s ${time}! (Mantenha esta aba aberta)`);

            const targetTime = new Date(`${date}T${time}`).getTime();
            const check = setInterval(() => {
                if (Date.now() >= targetTime) {
                    clearInterval(check);
                    iniciarDisparo();
                }
            }, 30000);
        }

        // --- GOOGLE MAPS LOGIC ---
        let mapsLeads = [];
        let placesService;

        function switchTab(tab) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            const pane = document.getElementById(`tab-${tab}`);
            const btn = document.getElementById(`btn-tab-${tab}`);

            if (pane) pane.classList.add('active');
            if (btn) btn.classList.add('active');
        }

        function initAutocomplete() {
            // Callback do Google Maps
            placesService = new google.maps.places.PlacesService(document.createElement('div'));
        }

        async function searchMaps() {
            const query = document.getElementById('mapsQuery').value;
            if (!query) return showToast("Digite o que procura.", "error");

            const btn = document.getElementById('btnMapsSearch');
            btn.disabled = true;
            btn.textContent = "üîç BUSCANDO...";

            mapsLeads = []; // Limpar anterior
            renderMapsResults();

            const request = { query: query };

            placesService.textSearch(request, async (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    showToast(`Buscando detalhes de ${results.length} locais...`);

                    for (const place of results) {
                        await new Promise(resolve => {
                            placesService.getDetails({
                                placeId: place.place_id,
                                fields: ['name', 'formatted_phone_number', 'formatted_address']
                            }, (details, dStatus) => {
                                if (dStatus === google.maps.places.PlacesServiceStatus.OK && details.formatted_phone_number) {
                                    mapsLeads.push({
                                        nome: details.name,
                                        telefone: details.formatted_phone_number,
                                        address: details.formatted_address
                                    });
                                    renderMapsResults(); // Update real-time
                                }
                                // Pequeno delay para evitar Rate Limit da API do Google
                                setTimeout(resolve, 200);
                            });
                        });
                    }

                    btn.disabled = false;
                    btn.textContent = "üîç BUSCAR LEADS";
                    showToast(`Busca finalizada! ${mapsLeads.length} leads com telefone.`);
                } else {
                    btn.disabled = false;
                    btn.textContent = "üîç BUSCAR LEADS";
                    showToast("Erro na busca: " + status, "error");
                }
            });
        }

        function renderMapsResults() {
            const list = document.getElementById('mapsResultsList');
            document.getElementById('mapsResultsCount').style.display = 'block';
            document.getElementById('totalMapsLeads').textContent = mapsLeads.length;
            document.getElementById('btnImportLeads').disabled = mapsLeads.length === 0;

            if (mapsLeads.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center;">Nenhum lead com telefone encontrado.</div>';
                return;
            }

            list.innerHTML = mapsLeads.map((lead, i) => `
                <div class="maps-item">
                    <div class="maps-info">
                        <h4>${lead.nome}</h4>
                        <p>${lead.telefone} | ${lead.address || ''}</p>
                    </div>
                    <input type="checkbox" class="maps-checkbox" data-index="${i}" checked>
                </div>
            `).join('');
        }

        function importLeadsToSender() {
            const selectedIdx = Array.from(document.querySelectorAll('.maps-checkbox:checked')).map(cb => cb.dataset.index);
            if (selectedIdx.length === 0) return showToast("Selecione ao menos um lead.", "error");

            const imported = selectedIdx.map(idx => {
                const lead = mapsLeads[idx];
                const phone = limparTelefone(lead.telefone);
                return {
                    nome: lead.nome,
                    telefone: lead.telefone,
                    _telefone_limpo: phone,
                    _nome_exibicao: lead.nome
                };
            });

            contatosData = [...contatosData, ...imported];
            mostrarPreview();
            switchTab('sender');
            showToast(`${imported.length} leads importados para o disparo!`);
        }
    </script>
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWIu9AMbRBq9eAZ7B_OzjBoLjfPIfiXZg&libraries=places&callback=initAutocomplete"></script>
</body>

</html>