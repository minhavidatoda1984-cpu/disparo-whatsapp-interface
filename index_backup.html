<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG Sender - WhatsApp Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --accent: #667eea;
            --accent-dark: #764ba2;
            --bg-dark: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1e293b, #0f172a);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
        }

        /* Background Effects */
        body::before {
            content: '';
            position: fixed;
            top: -10%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: var(--primary);
            filter: blur(150px);
            opacity: 0.15;
            z-index: -1;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -10%;
            left: -10%;
            width: 400px;
            height: 400px;
            background: var(--accent);
            filter: blur(150px);
            opacity: 0.15;
            z-index: -1;
        }

        .container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            max-width: 900px;
            width: 100%;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .header {
            padding: 40px 30px;
            text-align: center;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.02);
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(to right, #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-muted);
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        @media (max-width: 600px) {
            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 26px;
            }

            .header p {
                font-size: 13px;
            }
        }

        .content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 600px) {
            .content {
                padding: 20px;
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .config-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
        }

        .config-section h2 {
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 13px;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea {
            width: 100%;
            padding: 12px 14px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 14px;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 0 4px rgba(37, 211, 102, 0.1);
        }

        textarea {
            resize: none;
            min-height: 120px;
        }

        /* File Upload Styling */
        .file-upload-wrapper {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-upload-wrapper:hover {
            border-color: var(--primary);
            background: rgba(37, 211, 102, 0.05);
        }

        .file-upload-wrapper input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            pointer-events: none;
        }

        .file-upload-info span {
            font-size: 13px;
        }

        .icon-plus {
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* Info & Variable Pills */
        .variable-tips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .variable-pill {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            cursor: copy;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .variable-pill:hover {
            background: var(--primary);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Status & Logs */
        .preview-section {
            grid-column: span 2;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-top: 10px;
            border: 1px solid var(--glass-border);
        }

        @media (max-width: 768px) {
            .preview-section {
                grid-column: span 1;
            }
        }

        .preview-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .preview-item {
            padding: 10px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
        }

        .preview-item:last-child {
            border-bottom: none;
        }

        /* Progress Bar */
        .progress-container {
            grid-column: span 2;
            display: none;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Buttons */
        .button-group {
            grid-column: span 2;
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .button-group {
                flex-direction: column;
                grid-column: span 1;
            }

            .button-group button {
                width: 100%;
            }
        }

        button {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: black;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 211, 102, 0.2);
        }

        .btn-accent {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid var(--glass-border);
        }

        .btn-accent:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Notifications */
        .status-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 12px;
            background: #1e293b;
            border: 1px solid var(--glass-border);
            display: none;
            animation: slideUp 0.3s ease;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .media-preview-item {
            font-size: 11px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .remove-media {
            color: #ef4444;
            cursor: pointer;
        }

        /* Login Overlay */
        .login-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border-radius: 16px;
            transition: all 0.5s ease;
        }

        .login-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-box {
            width: 100%;
            max-width: 300px;
        }

        .login-box h3 {
            margin-bottom: 20px;
            text-align: center;
            color: var(--primary);
            font-size: 18px;
        }

        .login-box input {
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-login {
            width: 100%;
            background: var(--primary);
            color: #000;
            margin-top: 10px;
        }

        .locked-content {
            filter: blur(8px);
            pointer-events: none;
            user-select: none;
        }

        .unlocked .locked-content {
            filter: none;
            pointer-events: auto;
            user-select: auto;
        }

        /* Tabs System */
        .tabs-header {
            display: flex;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--glass-border);
            padding: 0 20px;
            overflow-x: auto;
            scrollbar-width: none;
            /* Firefox */
        }

        .tabs-header::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            transition: 0.3s;
            flex: none;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
            transform: none !important;
            box-shadow: none !important;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Maps Search styles */
        .maps-results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .maps-item {
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .maps-item:last-child {
            border-bottom: none;
        }

        .maps-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .maps-info p {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* QR Code Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            max-width: 400px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        .qr-placeholder {
            width: 250px;
            height: 250px;
            background: white;
            margin: 20px auto;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .qr-placeholder img {
            width: 100%;
            height: 100%;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <div id="qrModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeQRModal()">&times;</span>
            <h3 style="color: var(--primary); margin-bottom: 10px;">Conectar WhatsApp</h3>
            <p style="font-size: 13px; color: var(--text-muted);">Abra o WhatsApp > Configura√ß√µes > Aparelhos Conectados
                > Conectar um Aparelho</p>

            <div class="qr-placeholder" id="qrContainer">
                <div style="color: #000; font-size: 12px;">Gerando QR Code...</div>
            </div>

            <div id="connectionStatus" style="font-size: 14px; font-weight: 600; margin-top: 15px;">
                ‚è≥ Aguardando leitura...
            </div>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1 id="title-main">MG Sender <span style="font-weight: 300; opacity: 0.5;">v2.0</span></h1>
            <p>DESIGN PREMIUM &bull; DISPARO INTELIGENTE &bull; MULTI-M√çDIA</p>
        </div>

        <div class="tabs-header">
            <button id="btn-tab-sender" class="tab-btn active" onclick="switchTab('sender')">üî• DISPARO EM
                MASSA</button>
            <button id="btn-tab-maps" class="tab-btn" onclick="switchTab('maps')">üìç EXTRA√á√ÉO MAPS</button>
        </div>

        <!-- Tab 1: MG Sender -->
        <div id="tab-sender" class="tab-pane active">
            <div class="content">
                <!-- Coluna 1: Configura√ß√µes e Arquivos -->
                <div class="column">
                    <!-- CONFIGURA√á√ÉO N√çVEL 1: WEBHOOK E INST√ÇNCIA (SENHA: magnogomes) -->
                    <div class="config-section" style="position: relative; overflow: hidden; margin-bottom: 20px;"
                        id="configSectionUser">
                        <div id="loginOverlay" class="login-overlay">
                            <div class="login-box">
                                <h3>üîê Conex√£o do Usu√°rio</h3>
                                <input type="password" id="passLogin" placeholder="Senha de Acesso"
                                    style="width: 100%; padding: 12px 14px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; color: white; margin-bottom: 12px;">
                                <button class="btn-login" onclick="checkLogin()">LIBERAR ACESSO</button>
                            </div>
                        </div>
                        <div class="locked-content">
                            <h2>‚öôÔ∏è Conex√£o & Inst√¢ncia</h2>
                            <div class="form-group">
                                <label>Webhook URL (N8N)</label>
                                <input type="text" id="n8nWebhook" placeholder="Sua URL do Webhook"
                                    value="https://n8n.naturaisterravida.com.br/webhook/conexao-limpa-v1">
                            </div>
                            <div id="connectionPanel"
                                style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center;">
                                <div id="statusBadge"
                                    style="display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-bottom: 15px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2);">
                                    üî¥ N√ÉO CONECTADO
                                </div>
                                <h3 id="instanceDisplay" style="font-size: 14px; margin-bottom: 15px; display: none;">
                                    Sess√£o: <span style="color: var(--primary);">---</span></h3>
                                <button id="btnConnect" class="btn-primary" onclick="startQRConnection()"
                                    style="width: 100%;">
                                    üì≤ CONECTAR WHATSAPP
                                </button>
                                <p style="font-size: 11px; color: var(--text-muted); margin-top: 10px;">Clique acima
                                    para gerar o QR Code e parear seu aparelho.</p>
                                <input type="hidden" id="instanceName" value="">
                            </div>
                        </div>
                    </div>

                    <!-- CONFIGURA√á√ÉO N√çVEL 2: API KEY (SENHA: 212003) -->
                    <div class="config-section" style="position: relative; overflow: hidden; margin-bottom: 20px;"
                        id="configSectionMaster">
                        <div id="masterOverlay" class="login-overlay">
                            <div class="login-box">
                                <h3>üîë Chave de API Master</h3>
                                <input type="password" id="passMaster" placeholder="Senha Master"
                                    style="width: 100%; padding: 12px 14px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; color: white; margin-bottom: 12px;">
                                <button class="btn-login" onclick="unlockMasterData()"
                                    style="background: var(--accent); color: white;">REVELAR API KEY</button>
                            </div>
                        </div>
                        <div class="locked-content">
                            <h2>üõ°Ô∏è Seguran√ßa Evolution</h2>
                            <div class="form-group">
                                <label>API Key Evolution (Master)</label>
                                <input type="text" id="apiKey" placeholder="Chave API"
                                    value="f98fed17beccac0149db6cfe6bfb7fff">
                            </div>
                        </div>
                    </div>

                    <div class="config-section" style="margin-top: 20px;">
                        <h2>üìã Lista de Clientes</h2>
                        <div class="file-upload-wrapper">
                            <input type="file" id="excelFile" accept=".xlsx,.xls">
                            <div class="file-upload-info">
                                <div class="icon-plus">üìÅ</div>
                                <span id="fileNameDisplay">Arraste seu Excel ou clique aqui</span>
                                <span style="opacity: 0.5; font-size: 11px;">(Colunas recomendadas: Nome,
                                    Telefone)</span>
                            </div>
                        </div>

                        <div class="preview-section" id="previewSection" style="display: none; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px; color: var(--primary);">Total: <strong
                                        id="totalContacts">0</strong></span>
                                <label
                                    style="margin: 0; display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" checked>
                                    <span style="font-size: 12px;">Todos</span>
                                </label>
                            </div>
                            <div class="preview-list" id="previewList"></div>
                        </div>
                    </div>
                </div>

                <!-- Coluna 2: Mensagem e M√≠dia -->
                <div class="column">
                    <div class="config-section">
                        <h2>üí¨ Mensagem Personalizada</h2>
                        <div class="form-group">
                            <label>Sua Mensagem</label>
                            <textarea id="message"
                                placeholder="Ol√° {nome}, seu vencimento no dia {vencimento} est√° pr√≥ximo..."></textarea>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                <div class="variable-tips" id="variableTips">
                                    <span class="variable-pill" onclick="insertVar('{nome}')">{nome}</span>
                                </div>
                                <span style="font-size: 11px; color: var(--text-muted);"><span id="charCount">0</span>
                                    caracteres</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Delay entre mensagens (segndos)</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="msgDelay" value="30" min="5"
                                    style="width: 100%; padding: 12px 14px; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--glass-border); border-radius: 12px; font-size: 14px; color: white;">
                            </div>
                            <span style="font-size: 11px; color: var(--text-muted);">Recomendado: 30s para evitar
                                bloqueios. O sistema aguardar√° este tempo ap√≥s cada mensagem.</span>
                        </div>

                        <div class="form-group" style="margin-top: 15px;">
                            <label>Anexar M√≠dia (Opcional)</label>
                            <div class="file-upload-wrapper" style="padding: 15px;">
                                <input type="file" id="mediaFile" accept="image/*,video/*,application/pdf,audio/*">
                                <div class="file-upload-info">
                                    <div class="icon-plus" style="font-size: 18px;">üìé</div>
                                    <span id="mediaNameDisplay">Foto, V√≠deo, PDF ou √Åudio</span>
                                </div>
                            </div>
                            <div id="mediaPreview" style="margin-top: 10px;"></div>
                        </div>

                        <div class="button-group" style="margin-top: 25px;">
                            <button class="btn-primary" id="btnDisparar" onclick="iniciarDisparo()">
                                üöÄ INICIAR DISPARO
                            </button>
                        </div>

                        <div class="progress-container" id="progressContainer">
                            <div
                                style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
                                <span id="progressStatus">Enviando...</span>
                                <span id="progressPercent">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Extra√ß√£o Maps -->
        <div id="tab-maps" class="tab-pane">
            <div class="content">
                <div class="config-section" style="grid-column: span 2;">
                    <h2>üìç Extra√ß√£o de Leads (Google Maps)</h2>
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">
                        Busque empresas locais e adicione diretamente √† sua lista de disparo.
                    </p>

                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="mapsQuery" placeholder="Ex: Dentistas em S√£o Paulo, SP" style="flex: 1;">
                        <button class="btn-primary" onclick="searchMaps()" style="flex: none; width: auto;">üîç
                            BUSCAR</button>
                    </div>

                    <div id="mapsResults" class="maps-results" style="display: none;">
                        <!-- Resultados aqui -->
                    </div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn-accent" onclick="importMapsLeads()">‚¨á IMPORTAR SELECIONADOS</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="statusToast" class="status-toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <script>
        // CONFIGURA√á√ïES
        let contatosData = [];
        let base64Media = null;
        let mediaMimeType = null;
        let mediaFileName = null;
        let isAudio = false;

        // Tabs Logic
        function switchTab(tabName) {
            // Remove active class from all
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            // Add active class
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`btn-tab-${tabName}`).classList.add('active');
        }

        // UI Helpers
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('statusToast');
            toast.textContent = msg;
            toast.style.display = 'block';
            toast.style.borderColor = type === 'error' ? '#ef4444' : 'var(--glass-border)';
            toast.style.color = type === 'error' ? '#ef4444' : 'white';

            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function toggleSelectAll() {
            const isChecked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.contact-check').forEach(cb => cb.checked = isChecked);
        }

        // L√≥gica de Login
        function checkLogin() {
            const pass = document.getElementById('passLogin').value;

            if (pass === 'magnogomes') {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('configSectionUser').classList.add('unlocked');
                showToast('Acesso √† Conex√£o liberado!');
            } else {
                showToast('Senha de Acesso incorreta.', 'error');
            }
        }

        function unlockMasterData() {
            const pass = document.getElementById('passMaster').value;

            if (pass === '212003') {
                document.getElementById('masterOverlay').classList.add('hidden');
                document.getElementById('configSectionMaster').classList.add('unlocked');
                showToast('API Key Master liberada!');
            } else {
                showToast('Senha Master incorreta!', 'error');
            }
        }

        // Contador e Auto-resize
        document.getElementById('message').addEventListener('input', function () {
            document.getElementById('charCount').textContent = this.value.length;
        });

        function insertVar(v) {
            const area = document.getElementById('message');
            area.value += " " + v;
        }

        // File Upload Excel
        document.getElementById('excelFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileNameDisplay').textContent = file.name;
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                processContacts(jsonData);
            };
            reader.readAsArrayBuffer(file);
        });

        function processContacts(data) {
            contatosData = [];
            document.getElementById('previewList').innerHTML = '';

            // Detectar colunas
            if (data.length === 0) return;
            const keys = Object.keys(data[0]);

            // Tenta achar telefone e nome de forma inteligente
            let phoneKey = keys.find(k => k.toLowerCase().includes('tele') || k.toLowerCase().includes('cel') || k.toLowerCase().includes('phone') || k.toLowerCase().includes('whatsapp'));
            let nameKey = keys.find(k => k.toLowerCase().includes('nome') || k.toLowerCase().includes('name') || k.toLowerCase().includes('cliente') || k.toLowerCase().includes('lead') || k.toLowerCase().includes('contato'));

            if (!phoneKey) {
                alert("N√£o encontrei uma coluna de Telefone. Certifique-se que o Excel tem cabe√ßalho.");
                return;
            }

            // Popula vari√°veis sugeridas e lista
            const tips = document.getElementById('variableTips');
            tips.innerHTML = '';
            keys.forEach(k => {
                tips.innerHTML += `<span class="variable-pill" onclick="insertVar('{${k}}')">{${k}}</span>`;
            });

            data.forEach((row, index) => {
                let phone = String(row[phoneKey]).replace(/\D/g, '');
                // Basic BR validation
                if (phone.length < 10) return;
                if (phone.length === 10 || phone.length === 11) phone = "55" + phone;

                // Adiciona chave limpa
                row['_telefone_limpo'] = phone;

                const displayName = nameKey ? row[nameKey] : phone;

                contatosData.push(row);

                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    <input type="checkbox" class="contact-check" value="${index}" checked>
                    <div>
                        <strong>${displayName}</strong><br>
                        <span style="color:var(--text-muted); font-size:11px;">${phone}</span>
                    </div>
                `;
                document.getElementById('previewList').appendChild(div);
            });

            document.getElementById('totalContacts').textContent = contatosData.length;
            document.getElementById('previewSection').style.display = 'block';
        }


        // Media Upload
        document.getElementById('mediaFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('mediaNameDisplay').textContent = file.name;
            mediaFileName = file.name;
            mediaMimeType = file.type;
            isAudio = file.type.startsWith('audio');

            const reader = new FileReader();
            reader.onload = function (e) {
                base64Media = e.target.result.split(',')[1];
                document.getElementById('mediaPreview').innerHTML = `
                    <div class="media-preview-item">
                        <span>${isAudio ? 'üéµ' : 'üìé'} ${file.name}</span>
                        <span class="remove-media" onclick="removeMedia()">‚úï</span>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        });

        function removeMedia() {
            document.getElementById('mediaFile').value = '';
            base64Media = null;
            mediaMimeType = null;
            mediaFileName = null;
            document.getElementById('mediaNameDisplay').textContent = 'Foto, V√≠deo, PDF ou √Åudio';
            document.getElementById('mediaPreview').innerHTML = '';
        }

        // Disparo
        async function iniciarDisparo() {
            const btn = document.getElementById('btnDisparar');
            const checks = document.querySelectorAll('.contact-check:checked');

            if (checks.length === 0) {
                showToast("Selecione pelo menos um contato.", "error");
                return;
            }

            const instanceName = document.getElementById('instanceName').value;
            const webhookUrl = document.getElementById('n8nWebhook').value;
            const apiKey = document.getElementById('apiKey').value;
            const msgTemplate = document.getElementById('message').value;
            const msgDelay = parseInt(document.getElementById('msgDelay').value) || 5;

            if (!instanceName) return showToast("Defina sua Inst√¢ncia.", "error");
            if (!webhookUrl) return showToast("Configure o Webhook.", "error");
            if (!msgTemplate && !base64Media) return showToast("Escreva uma mensagem ou anexe m√≠dia.", "error");

            btn.disabled = true;
            document.getElementById('progressContainer').style.display = 'block';

            let count = 0;
            const total = checks.length;

            for (const check of checks) {
                const index = check.value;
                const contato = contatosData[index];

                let mensagemFinal = msgTemplate;
                Object.keys(contato).forEach(key => {
                    mensagemFinal = mensagemFinal.replace(new RegExp(`{${key}}`, 'g'), contato[key]);
                });

                const payload = {
                    number: contato._telefone_limpo,
                    message: mensagemFinal,
                    media: base64Media,
                    mediaName: mediaFileName,
                    mimeType: mediaMimeType,
                    isAudio: isAudio,
                    apiKey: apiKey,
                    instance: instanceName,
                    delay: msgDelay,
                    contatoInfo: contato
                };

                try {
                    await fetch(webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    count++;
                    updateProgress(count, total);
                } catch (e) {
                    console.error("Erro no contato:", contato._telefone_limpo, e);
                }
            }

            showToast(`Disparo Finalizado! ${count} enviados.`);
            btn.disabled = false;
        }

        function updateProgress(curr, tot) {
            const p = (curr / tot) * 100;
            document.getElementById('progressFill').style.width = p + '%';
            document.getElementById('progressPercent').textContent = Math.round(p) + '%';
            document.getElementById('progressStatus').textContent = `Enviando ${curr} de ${tot}...`;
        }

        function limparFormulario() {
            if (confirm("Deseja realmente limpar tudo?")) {
                location.reload();
            }
        }

        function agendarDisparo() {
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            if (!date || !time) {
                showToast("Selecione data e hora para agendar.", "error");
                return;
            }
            showToast(`Agendado com sucesso para ${date} √†s ${time}! (Mantenha esta aba aberta)`);

            const targetTime = new Date(`${date}T${time}`).getTime();
            const check = setInterval(() => {
                if (Date.now() >= targetTime) {
                    clearInterval(check);
                    iniciarDisparo();
                }
            }, 30000);
        }

        // Carregar configura√ß√µes salvas
        window.addEventListener('load', () => {
            const savedWebhook = localStorage.getItem('mg_webhook');
            const savedKey = localStorage.getItem('mg_apikey');
            const savedInstance = localStorage.getItem('mg_instance');

            if (savedWebhook) document.getElementById('n8nWebhook').value = savedWebhook;
            if (savedKey) document.getElementById('apiKey').value = savedKey;

            if (savedInstance) {
                document.getElementById('instanceName').value = savedInstance;
                updateConnectionUI(savedInstance);
                checkInstanceStatus(savedInstance);
            }
        });

        function updateConnectionUI(instance) {
            document.getElementById('instanceDisplay').style.display = 'block';
            document.getElementById('instanceDisplay').querySelector('span').textContent = instance;
            document.getElementById('btnConnect').textContent = "üîÑ RECONECTAR / TROCAR";
        }

        async function checkInstanceStatus(instance) {
            const apiKey = document.getElementById('apiKey').value || 'f98fed17beccac0149db6cfe6bfb7fff';
            try {
                const res = await fetch(`${EVOLUTION_URL}/instance/connectionState/${instance}`, {
                    headers: { 'apikey': apiKey }
                });
                const data = await res.json();
                const badge = document.getElementById('statusBadge');

                if (data.instance && data.instance.state === "open") {
                    badge.innerHTML = "üü¢ WHATSAPP CONECTADO";
                    badge.style.background = "rgba(37, 211, 102, 0.1)";
                    badge.style.color = "var(--primary)";
                    badge.style.borderColor = "rgba(37, 211, 102, 0.2)";
                }
            } catch (e) { console.log("Erro status:", e); }
        }

        function saveConfig() {
            localStorage.setItem('mg_webhook', document.getElementById('n8nWebhook').value);
            localStorage.setItem('mg_apikey', document.getElementById('apiKey').value);
            localStorage.setItem('mg_instance', document.getElementById('instanceName').value);
        }

        // --- QR CODE & CONNECTION LOGIC ---
        let statusInterval = null;
        const EVOLUTION_URL = 'https://evolution.naturaisterravida.com.br';

        async function startQRConnection() {
            let instance = document.getElementById('instanceName').value;
            const apiKey = document.getElementById('apiKey').value;

            // Se n√£o tiver inst√¢ncia, gera uma aleat√≥ria autom√°tica
            if (!instance) {
                instance = 'mg_' + Math.random().toString(36).substring(2, 9);
                document.getElementById('instanceName').value = instance;
                saveConfig();
            }

            if (!apiKey) return showToast("Chave API master n√£o configurada.", "error");

            document.getElementById('qrModal').style.display = 'flex';
            document.getElementById('qrContainer').innerHTML = '<div style="color: #000; font-size: 12px; text-align: center;">Configurando inst√¢ncia...</div>';
            document.getElementById('connectionStatus').textContent = "‚è≥ Preparando servidor...";

            try {
                // 1. Tentar criar inst√¢ncia (ignoramos erros de 'j√° existe')
                const createRes = await fetch(`${EVOLUTION_URL}/instance/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'apikey': apiKey },
                    body: JSON.stringify({
                        instanceName: instance,
                        token: apiKey,
                        qrcode: true,
                        integration: 'WHATSAPP-BAILEYS'
                    })
                });

                // Pequeno delay para o servidor processar a cria√ß√£o
                await new Promise(r => setTimeout(r, 2000));

                // 2. Buscar o QR Code
                const response = await fetch(`${EVOLUTION_URL}/instance/connect/${instance}`, {
                    headers: { 'apikey': apiKey }
                });
                const data = await response.json();

                if (data.base64) {
                    document.getElementById('qrContainer').innerHTML = `<img src="${data.base64}" alt="QR Code" style="width: 100%; height: 100%; object-fit: contain;">`;
                    document.getElementById('connectionStatus').textContent = "üì∏ Escaneie o c√≥digo acima";
                    startStatusPolling(instance, apiKey);
                } else if (data.status === "open" || (data.instance && data.instance.state === "open")) {
                    document.getElementById('qrContainer').innerHTML = '<div style="color: #000; font-size: 40px; display: flex; align-items: center; justify-content: center; height: 100%;">‚úÖ</div>';
                    document.getElementById('connectionStatus').textContent = "‚úÖ WhatsApp j√° conectado!";
                    updateConnectionUI(instance);
                    checkInstanceStatus(instance);
                    setTimeout(closeQRModal, 2000);
                } else {
                    console.error("Erro detalhado da API:", data);
                    const errorMsg = data.message || data.error || data.msg || "Erro desconhecido no servidor";
                    document.getElementById('qrContainer').innerHTML = `<div style="color: #000; font-size: 11px; padding: 20px; word-break: break-all;">O servidor n√£o retornou o QR Code.<br><br><b>Mensagem:</b> ${errorMsg}<br><br><b>Dica:</b> Tente um nome diferente de inst√¢ncia ou verifique se a API Key Master est√° correta.</div>`;
                    document.getElementById('connectionStatus').textContent = "‚ö†Ô∏è Erro na Resposta";
                }

            } catch (err) {
                console.error("Erro na conex√£o:", err);
                document.getElementById('qrContainer').innerHTML = `<div style="color: #000; font-size: 11px; padding: 20px;">Falha na rede ou servidor offline.<br><br>${err.message}</div>`;
                document.getElementById('connectionStatus').textContent = "‚ùå Falha de Rede";
            }
        }

        function startStatusPolling(instance, apiKey) {
            if (statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${EVOLUTION_URL}/instance/connectionState/${instance}`, {
                        headers: { 'apikey': apiKey }
                    });
                    const data = await res.json();

                    if (data.instance.state === "open") {
                        clearInterval(statusInterval);
                        document.getElementById('connectionStatus').textContent = "‚úÖ CONECTADO!";
                        document.getElementById('connectionStatus').style.color = "var(--primary)";
                        showToast("WhatsApp pareado com sucesso!");
                        updateConnectionUI(instance);
                        checkInstanceStatus(instance);
                        setTimeout(closeQRModal, 2000);
                    }
                } catch (e) {
                    console.error("Erro no polling:", e);
                }
            }, 3000);
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
            if (statusInterval) clearInterval(statusInterval);
        }

        // --- GOOGLE MAPS LOGIC ---
        let mapsLeads = [];
        let placesService;

        async function initMap() {
            // Inicializa o servi√ßo do Places (sem mapa visual, apenas servi√ßo)
            // Hack: cria um elemento invis√≠vel para o mapa
            const mapDiv = document.createElement('div');
            const map = new google.maps.Map(mapDiv, { center: { lat: -23.55, lng: -46.63 }, zoom: 10 });
            placesService = new google.maps.places.PlacesService(map);
        }

        function searchMaps() {
            const query = document.getElementById('mapsQuery').value;
            if (!query) return showToast("Digite uma busca (ex: Pizzaria em SP)", "error");

            document.getElementById('mapsResults').style.display = 'block';
            document.getElementById('mapsResults').innerHTML = '<div style="padding:20px; text-align:center;">üîç Buscando no Google...</div>';

            const request = {
                query: query,
                fields: ['name', 'formatted_address', 'place_id', 'geometry']
            };

            placesService.textSearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    displayMapsResults(results);
                } else {
                    document.getElementById('mapsResults').innerHTML = '<div style="padding:20px; text-align:center;">‚ùå Nenhum resultado encontrado.</div>';
                }
            });
        }

        function displayMapsResults(results) {
            const container = document.getElementById('mapsResults');
            container.innerHTML = '';
            mapsLeads = [];

            results.forEach((place, index) => {
                // Para cada lugar, precisamos buscar os detalhes (telefone)
                const div = document.createElement('div');
                div.className = 'maps-item';
                div.id = `map-item-${index}`;
                div.innerHTML = `
            <div class="maps-info">
                <h4>${place.name}</h4>
                <p>üìç ${place.formatted_address}</p>
                <p id="phone-p-${index}" style="color: var(--primary);">‚è≥ Buscando telefone...</p>
            </div>
            <input type="checkbox" id="check-map-${index}" disabled>
        `;
                container.appendChild(div);

                // Busca detalhes
                placesService.getDetails({
                    placeId: place.place_id,
                    fields: ['name', 'formatted_phone_number', 'international_phone_number']
                }, (placeDetails, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && placeDetails.formatted_phone_number) {
                        const phone = placeDetails.international_phone_number || placeDetails.formatted_phone_number;
                        const cleanPhone = phone.replace(/\D/g, '');

                        document.getElementById(`phone-p-${index}`).textContent = `üìû ${phone}`;
                        const check = document.getElementById(`check-map-${index}`);
                        check.disabled = false;
                        check.checked = true;

                        mapsLeads[index] = {
                            name: place.name,
                            phone: cleanPhone
                        };
                    } else {
                        document.getElementById(`phone-p-${index}`).textContent = `‚ùå Sem telefone`;
                        // Remove item se n√£o tiver telefone? Opcional. 
                        // Vamos manter mas desabilitado
                    }
                });
            });
        }

        function importMapsLeads() {
            let count = 0;
            mapsLeads.forEach((lead, index) => {
                const check = document.getElementById(`check-map-${index}`);
                if (check && check.checked && lead) {
                    // Adiciona √† lista principal
                    contatosData.push({
                        'Nome': lead.name,
                        'Telefone': lead.phone,
                        '_telefone_limpo': lead.phone
                    });
                    count++;
                }
            });

            if (count > 0) {
                switchTab('sender');
                // Re-render preview
                processContacts(contatosData);
                showToast(`${count} leads importados com sucesso!`);
            } else {
                showToast("Nenhum lead selecionado.", "error");
            }
        }
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWIu9AMbRBq9eAZ7B_OzjBoLjfPIfiXZg&libraries=places&callback=initMap"></script>
</body>

</html>